<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Will Anderson]]></title>
  <link href="http://willi.am/atom.xml" rel="self"/>
  <link href="http://willi.am/"/>
  <updated>2015-03-31T09:32:51-07:00</updated>
  <id>http://willi.am/</id>
  <author>
    <name><![CDATA[Will Anderson]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Obvious Code]]></title>
    <link href="http://willi.am/blog/2015/03/27/obvious-code/"/>
    <updated>2015-03-27T04:10:17-07:00</updated>
    <id>http://willi.am/blog/2015/03/27/obvious-code</id>
    <content type="html"><![CDATA[<p>A week or two ago, I got this feedback on a code review:</p>

<blockquote><p>You&rsquo;re using <code>foo ? foo : ""</code> here.
It would be shorter and more obvious if you wrote it as <code>foo || ""</code></p></blockquote>

<p>This was valid feedback, and I updated the code.</p>

<p>After I&rsquo;d checked in my changes, I got the following IM from a senior member of my team:</p>

<blockquote><p>I see you did <code>foo || ""</code>? What does the <code>||</code> mean?</p></blockquote>

<p>:)</p>

<p>This was a good reminder of two things:</p>

<ul>
<li>&ldquo;Obvious code&rdquo; is a subjective concept</li>
<li>No matter how experienced you are with something, you&rsquo;ll still find blind spots from time to time</li>
</ul>


<p><em>P.S.</em> If that syntax is also new to you, it&rsquo;s taking advantage of how JavaScript does &ldquo;or&rdquo;.
A JavaScript <em>or</em> returns the first <em>truthy</em> value, or the last value if none are truthy:</p>

<p>e.g. <code>(false || 0) === 0</code> and <code>(0 || false) === false</code> and <code>(foo || "") === ""</code> (assuming foo is &ldquo;falsey&rdquo;)</p>

<p>Many JavaScript developers use this behavior as a shortcut for setting default values, because <code>null</code> and <code>undefined</code> are falsey.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Dynamically Configure Your Git Email]]></title>
    <link href="http://willi.am/blog/2015/02/27/dynamically-configure-your-git-email/"/>
    <updated>2015-02-27T14:29:42-08:00</updated>
    <id>http://willi.am/blog/2015/02/27/dynamically-configure-your-git-email</id>
    <content type="html"><![CDATA[<blockquote><p>This post is the second in a series on tuning your Git environment.
The first post on <a href="http://willi.am/blog/2015/02/19/customize-your-git-log-format/">customizing your git log</a> isn&rsquo;t a prerequisite, but may be useful.</p></blockquote>

<h2>Managing Multiple Commit Emails</h2>

<p>If you use Git at work and in your personal time, managing the email you use for commit messages can be tricky.</p>

<p>When my previous team first started using Git, I had several instances where I accidentally committed to our team repository with my personal email address.
This wasn&rsquo;t a big problem, but it made the repository history look a little messy, and it meant my picture didn&rsquo;t show up properly in the UI tools.</p>

<h2>Simple Fix: Manually Configure Email Per Repository</h2>

<p>My first solution was to remove the global configuration for my email address:</p>

<p><code>git config --global --unset user.email</code></p>

<p>This way when I committed into a fresh repository, I&rsquo;d get a warning that I hadn&rsquo;t configured my email.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Your name and email address were configured automatically based
</span><span class='line'>on your username and hostname. Please check that they are accurate.
</span><span class='line'>You can suppress this message by setting them explicitly:
</span><span class='line'>
</span><span class='line'>    git config --global user.name "Your Name"
</span><span class='line'>    git config --global user.email you@example.com
</span><span class='line'>
</span><span class='line'>After doing this, you may fix the identity used for this commit with:
</span><span class='line'>
</span><span class='line'>    git commit --amend --reset-author
</span><span class='line'>
</span><span class='line'> 1 file changed, 0 insertions(+), 0 deletions(-)
</span><span class='line'> create mode 100644 foo1</span></code></pre></td></tr></table></div></figure>


<p>Then I just had to configure my email <strong>locally</strong> for that repository:</p>

<p><code>git config user.email will@itsananderson.com</code></p>

<p>And update the commit with the right author data:</p>

<p><code>git commit --amend --reset-author</code></p>

<h2>Medium Fix: Add Some Git Aliases</h2>

<p>Running through those steps for every new repository quickly becomes tedious, especially when you like to spin up GitHub projects for every idea that pops into your head.</p>

<p>To simplify things, I first created an alias for the <code>git commit --amend --reset-author</code> command.
I called it <code>cara</code> for &ldquo;Commit Amend Reset Author&rdquo;, but you could call it whatever you&rsquo;ll remember.
With that alias, it&rsquo;s super quick to fix a commit if I create it with the wrong author email.</p>

<p>The next thing I aliased was a script to guess the author email based on the repository URL.
I created a script and put it in <code>~/.git-scripts/email-guess.sh</code> (again, call it whatever you&rsquo;ll remember).</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="c">#!/bin/bash</span>
</span><span class='line'>
</span><span class='line'><span class="nv">remote</span><span class="o">=</span><span class="sb">`</span>git remote -v | awk <span class="s1">&#39;/\(push\)$/ {print $2}&#39;</span><span class="sb">`</span>
</span><span class='line'><span class="nv">email</span><span class="o">=</span>will@itsananderson.com <span class="c"># default</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="o">[[</span> <span class="nv">$remote</span> <span class="o">==</span> *github.com:Microsoft* <span class="o">]]</span>; <span class="k">then</span>
</span><span class='line'><span class="k">  </span><span class="nv">email</span><span class="o">=</span>wiand@microsoft.com
</span><span class='line'><span class="k">fi</span>
</span><span class='line'><span class="k">if</span> <span class="o">[[</span> <span class="nv">$remote</span> <span class="o">==</span> *itsananderson.visualstudio.com* <span class="o">]]</span>; <span class="k">then</span>
</span><span class='line'><span class="k">  </span><span class="nv">email</span><span class="o">=</span>will@codeawhile.com
</span><span class='line'><span class="k">fi</span>
</span><span class='line'>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;Configuring user.email as $email&quot;</span>
</span><span class='line'>git config user.email <span class="nv">$email</span>
</span></code></pre></td></tr></table></div></figure>


<p>The script isn&rsquo;t exactly a masterpiece, but it gets the job done.
<a href="https://github.com/itsananderson/git-better/blob/master/itsananderson/git-scripts/email-guess.sh">Feel free to copy and modify it to meet your needs</a>.</p>

<p>For the script to be useful, I aliased it as <code>git email-guess</code>:</p>

<p><code>git config --global alias.email-guess \!". ~/.git-scripts/email-guess.sh" ""</code></p>

<p>So now when I clone a new repository, I just <code>git email-guess</code> to set the email.
If I forgot to do it before my first commit, I follow it with <code>git cara</code> to fix that commit&rsquo;s author.</p>

<h2>Advanced Fix: Full Automation</h2>

<p>Reducing the work of author email management to only 1 or 2 commands is nice, but I wanted to eliminate it altogether.
This is where <a href="http://www.git-scm.com/book/en/v2/Customizing-Git-Git-Hooks">Git hooks</a> came in handy.</p>

<p>You can configure a Git hook manually for each repository, but again, we want this to be automated.
To do that, you&rsquo;ll want to modify the template hooks Git uses when it creates new repositories.</p>

<p>On Windows, these hook templates are located somewhere near <code>C:\Program Files (x86)\Git\share\git-core\templates\hooks</code>.
On OS X and Linux, they should be somewhere under the Git directory.
Running <code>which git</code> or <code>cat &#96;which git&#96;</code> should point you in the right direction.</p>

<p>Once you locate the template hooks directory, create a file called <code>post-checkout</code> with the following contents:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="c">#!/bin/bash</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="o">[[</span> <span class="nv">$1</span> <span class="o">==</span> 00000000000* <span class="o">]]</span>; <span class="k">then</span>
</span><span class='line'><span class="k">  </span>git email-guess
</span><span class='line'><span class="k">fi</span>
</span></code></pre></td></tr></table></div></figure>


<p>All this does is test whether Git checked out a freshly cloned repository (thus &ldquo;previous SHA&rdquo; is all zeros).
If so, it runs <code>git email-guess</code> to set up the correct author email.</p>

<h2>Wrapping Up</h2>

<p>So that&rsquo;s the full rundown of my email configuration setup.
As I said in the previous post, you should take this as an example that you can customize it to fit your needs.</p>

<p>You can find most of my Git configuration in my <a href="https://github.com/itsananderson/git-better">git-better</a> repository on GitHub.</p>

<p>As one example, there are many other Git hooks that you can take advantage of.
<a href="http://www.git-scm.com/book/en/v2/Customizing-Git-Git-Hooks">Take a look</a> to see if there are any that you could use to automate a frequent task.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Customize Your Git Log Format]]></title>
    <link href="http://willi.am/blog/2015/02/19/customize-your-git-log-format/"/>
    <updated>2015-02-19T14:29:06-08:00</updated>
    <id>http://willi.am/blog/2015/02/19/customize-your-git-log-format</id>
    <content type="html"><![CDATA[<blockquote><p>Over the last few months, I&#8217;ve been learning about woodworking in my spare time. As I&#8217;ve read articles and watched YouTube videos, I&#8217;ve noticed that the most successful woodworkers have a detailed knowledge of their tools. Not only do they know how to use and maintain the tools of their craft, but they&#8217;re not afraid to modify them to better serve their needs. When they need a custom tool or jig to speed up their work, they make one. Watching and reading about these craftsmen and their tools, I&#8217;ve noticed parallels in my full time craft: Software Development.</p><p>In the next few posts, I&#8217;ll share some of the software &#8220;jigs&#8221; I&#8217;ve created to make myself more efficient. The primary focus posts will be configuration and customization of Git.</p></blockquote>


<h2>Git Log: Your Own Personal Journal</h2>

<p>If you&rsquo;re not already aware, your Git log is a critical tool for working with source control.
Because your memory&rsquo;s not perfect, a good log helps you recall what you&rsquo;ve done, and the motivation behind it.</p>

<p>I&rsquo;ve <a href="http://willi.am/blog/2014/05/06/git-for-devs-who-cant-commit-good/">written before</a> about writing good commit messages, as has David in his series <a href="http://www.davidruttka.com/blog/2014/06/04/committed-to-good-commits-messages/">&ldquo;Committed to Good Commits&rdquo;</a>.
If your commit logs are sprinkled with gems like &ldquo;did stuff&rdquo; and &ldquo;it finally works!&rdquo;, you&rsquo;ll want to check out those posts.</p>

<h2>Choose Your Details With <code>--format</code></h2>

<p>Depending on what you&rsquo;re looking for in your log, you may want different levels of detail.
The Git log documentation has a <a href="https://www.kernel.org/pub/software/scm/git/docs/git-log.html#_pretty_formats">full list of the built-in formats</a>.</p>

<p>For example, if you&rsquo;re trying to find the SHA for a recent change, you may just want to see the SHA and the commit subject for each commit.
In that case, <code>git log --format=oneline</code> or <code>git log --oneline</code> is what you need.</p>

<p><img src="http://itsananderson.blob.core.windows.net/post-images/git-log-oneline.png"></p>

<p>If you need verbose output, including the full message and author info, <code>--format=medium</code> is a good option.</p>

<p><img src="http://itsananderson.blob.core.windows.net/post-images/git-log-medium.png"></p>

<p>Finally, if you want every single detail from the commit, <code>--format=fuller</code> will give you that.</p>

<p><img src="http://itsananderson.blob.core.windows.net/post-images/git-log-fuller.png"></p>

<p>If you want to make any of these formats your default, you can do so with the following command:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>git config --global format.pretty oneline <span class="c"># replace oneline with the format you want</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Limit Results With <code>-n</code></h2>

<p>If you only want to see the last few commits, you can use the <code>-n</code> flag.
The more verbose version is <code>-n &lt;number&gt;</code> (e.g. <code>-n 5</code> to show the last 5 commits).</p>

<p>Alternatively, you can use an even quicker shortcut.
Just use <code>-&lt;number&gt;</code>. For example: <code>git log -5</code> will show the last 5 commits.</p>

<h2>Fully Customize Your Log Output</h2>

<p>Depending on how you use your commit log, you may find that no built-in log format exactly fits your needs.
What I&rsquo;ve found is that the verbose formats are too hard to scan through, and the succinct ones don&rsquo;t have vital info.</p>

<p>To solve this problem, I created a custom log format, which I use almost exclusively.</p>

<p>You can configure my format with the following command:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>git config --global format.pretty format:"%C(auto)%h %d%Creset %s%n%Cgreen%ad%Creset %aN &lt;%aE>%n"</span></code></pre></td></tr></table></div></figure>


<p>The output looks like this:</p>

<p><img src="http://itsananderson.blob.core.windows.net/post-images/git-log-custom.png"></p>

<p>This format also works with the <code>--graph</code> flag:</p>

<p><img src="http://itsananderson.blob.core.windows.net/post-images/git-log-graph-format.png"></p>

<p>What I like about this format is that it only uses three lines per commit, but it has all the information I care about.
I also inserted color codes for the various parts of the message, which makes it even easier to grok.</p>

<h2>In Conclusion</h2>

<p>Hopefully these examples give you some ideas about what you can do to customize your commit log.
Don&rsquo;t feel like you need to use my custom log format as-is.
The whole point is to customize it to fit your needs.</p>

<p>If you want to test out different custom formats quickly, you can pass them directly to <code>git log</code> like so:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>git log --format=format:"%C(auto)%h %C(green)%aN%Creset %s"</span></code></pre></td></tr></table></div></figure>


<p><img src="http://itsananderson.blob.core.windows.net/post-images/git-log-custom-flag.png"></p>

<p>You can find the different placeholder options in the same <a href="https://www.kernel.org/pub/software/scm/git/docs/git-log.html#_pretty_formats">Pretty Formats</a> section of the Git Log documentation.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Netgear Nighthawk AC1900 (R7000) Review]]></title>
    <link href="http://willi.am/blog/2015/02/04/netgear-nighthawk-ac1900-r7000-review/"/>
    <updated>2015-02-04T22:13:14-08:00</updated>
    <id>http://willi.am/blog/2015/02/04/netgear-nighthawk-ac1900-r7000-review</id>
    <content type="html"><![CDATA[<p>I bought a new Wi-Fi router about a year ago, and I&rsquo;ve been so happy with it that I decided to write a review.</p>

<h2>The Goods</h2>

<p>Netgear has a truly impressive lineup of high-quality routers in their Nighthawk series.</p>

<p>When I purchased the Nighthawk R7000, it was the only Nighthawk available, but now there are three options.</p>

<h3>Nighthawk AC1900 (R7000)</h3>

<p><a href="http://www.amazon.com/gp/product/B00F0DD0I6?ie=UTF8&amp;camp=213733&amp;creative=393185&amp;creativeASIN=B00F0DD0I6&amp;linkCode=shr&amp;tag=itsananderson-20&amp;linkId=BOLZOX4JTJAYBWR2"><img src="http://itsananderson.blob.core.windows.net/post-images/nighthawk-r7000.jpg" alt="" /></a></p>

<p>This is the router I purchased.
At $176, it is now the cheapest one in the series, but don&rsquo;t let that fool you.
It&rsquo;s a beast.</p>

<h3>Nighthawk X4 AC2350 (R7500)</h3>

<p><a href="http://www.amazon.com/gp/product/B00MRVJY5C?ie=UTF8&amp;camp=213733&amp;creative=393177&amp;creativeASIN=B00MRVJY5C&amp;linkCode=shr&amp;tag=itsananderson-20&amp;linkId=VIPUHQZWDGEZTHRJ&amp;f_rd_m=ATVPDKIKX0DER&amp;pf_rd_s=center-2&amp;pf_rd_r=15AA64WNHBH3N7C3AG2S&amp;pf_rd_t=101&amp;pf_rd_p=2034761682&amp;pf_rd_i=9524228011"><img src="http://itsananderson.blob.core.windows.net/post-images/nighthawk-r7500.jpg" alt="" /></a></p>

<p>This model has an additional antena, a faster processor, and boasts improved range and faster bandwidth. It costs about $100 more than the R7000. This router uses a more advanced radio than the R7000 that apparently has higher throughput and reliability. That being said, I haven&rsquo;t experienced any problems with the throughput or reliability of the R7000.</p>

<h3>Nighthawk X6 AC3200 (R8000)</h3>

<p><a href="http://www.amazon.com/gp/product/B00KWHMR6G?ie=UTF8&amp;camp=213733&amp;creative=393177&amp;creativeASIN=B00KWHMR6G&amp;linkCode=shr&amp;tag=itsananderson-20&amp;linkId=62Y4XCEYOOJRGP7I&amp;f_rd_m=ATVPDKIKX0DER&amp;pf_rd_s=center-2&amp;pf_rd_r=15AA64WNHBH3N7C3AG2S&amp;pf_rd_t=101&amp;pf_rd_p=2034761682&amp;pf_rd_i=9524228011"><img src="http://itsananderson.blob.core.windows.net/post-images/nighthawk-r8000.jpg" alt="" /></a></p>

<p>This model has 6 antenas, which again boosts range and bandwidth.
It also supports a third Wi-Fi band, and assigns slower and faster devices to different bands, boosting performance for fast devices.
This model is only about $5 more than the R7500 ($105 more than the R7000), so if I were to upgrade, this is the model I would choose, because of it&rsquo;s significantly improved bandwidth.</p>

<h2>Price</h2>

<p>Here&rsquo;s a side-by-side comparison of the different models.</p>

<table>
    <tr><th>Model</th><th>Price</th></tr>
    <tr><td>Nighthawk (R7000)</td><td>$176</td></tr>
    <tr><td>&nbsp;Nighthawk X4 (R7500)</td><td>$279</td></tr>
    <tr><td>&nbsp;Nighthawk X6 (R8000)</td><td>$283</td></tr>
</table>


<p>When I first considered this router, the price was what gave me the most pause.
In the past, the most I&rsquo;d paid for a router was about $40, so this seemed like a significant price bump.
In the end, the only reason I bought it was because a friend had bought one and was very happy with it.</p>

<p>After using it for a year, I don&rsquo;t think I&rsquo;ll ever buy a &ldquo;cheap&rdquo; router again.
In the case of Wi-Fi routers, it seems that &ldquo;you get what you pay for&rdquo; holds true.</p>

<h2>Reliability and Performance</h2>

<p>My primary reason for upgrading my router was that my previous router, an older Linksys in the $30-40 range, didn&rsquo;t reliably reach the entire house.
After enough complaints from one roommate who&rsquo;s bedroom was in the far corner of the house, I decided to upgrade.</p>

<p>After installing the R7000, I&rsquo;ve stopped having router issues.
The signal reaches to every corner of the house, and has never cut out.</p>

<p>I eventually even swapped out the Ethernet cables in my two desktop computers, replacing them with this <a href="http://www.amazon.com/gp/product/B007GMPZ0A?ie=UTF8&amp;camp=213733&amp;creative=393185&amp;creativeASIN=B007GMPZ0A&amp;linkCode=shr&amp;tag=itsananderson-20&amp;linkId=E3Z7SM7WKO2M3UVP&amp;psc=1">Dual Band Wireless PCI Express adapter</a>.
Even after getting rid of the hard line, I get blazing fast speeds on both machines.</p>

<h2>Extra Features</h2>

<h3>Mounting Slots</h3>

<p>One of the things I took advantage of immediately was the slots on the back for mounting it on a wall.
Moving the router to a more central location in my downstairs hallway provided even better coverage throughout the house.</p>

<p><img src="http://itsananderson.blob.core.windows.net/post-images/mounted-router.jpg" alt="" /></p>

<p><small><em>(yes, that&rsquo;s a Raspberry Pi unceremoniously dangling from the router. Don&rsquo;t judge me)</em></small></p>

<p>Pro tip: make sure there&rsquo;s a power outlet within easy reach of your desired location <strong>before</strong> you start screwing in drywall anchors :)</p>

<h3>Web-based WPS Button</h3>

<p>Most routers support WPS. This allows new clients to connect to a network by clicking a physical button on the router.
This is convenient, but who wants to have to get up and walk over to the router.</p>

<p>Fortunately the Nighthawk web UI has a button you can push to do the same thing.</p>

<p><img src="http://itsananderson.blob.core.windows.net/post-images/soft-wps-button.png" alt="" /></p>

<p><img src="http://itsananderson.blob.core.windows.net/post-images/wifi-client-connected.png" alt="" /></p>

<h3>Easy Firmware Upgrade</h3>

<p>Most of my past routers have had a really archaic update process. Usually you have to manually flash the firmware and go through a convoluted restart process.</p>

<p>The R7000, on the other hand, just requires one or two clicks to install the update and automatically restart.</p>

<h3>And So Much More</h3>

<p>I usually install DD-WRT on any router I buy, but the R7000 has all the features I typically use, so I&rsquo;m just running the stock firmware.
Here are a few of the things I use most frequently:</p>

<ul>
<li>View attached devices</li>
<li>Port forwarding</li>
<li>Assign static LAN IPs</li>
<li>View traffic statistics</li>
</ul>


<h2>In Conclusion</h2>

<p>If you&rsquo;re tired of buying cheap routers that crap out after a year or two, I highly recommend the <a href="http://www.amazon.com/gp/product/B00F0DD0I6?ie=UTF8&amp;camp=213733&amp;creative=393185&amp;creativeASIN=B00F0DD0I6&amp;linkCode=shr&amp;tag=itsananderson-20&amp;linkId=BOLZOX4JTJAYBWR2">Nighthawk R7000</a>.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[A New Adventure in DevDiv]]></title>
    <link href="http://willi.am/blog/2014/11/12/a-new-adventure-in-devdiv/"/>
    <updated>2014-11-12T16:40:57-08:00</updated>
    <id>http://willi.am/blog/2014/11/12/a-new-adventure-in-devdiv</id>
    <content type="html"><![CDATA[<p>Starting Monday, I&rsquo;m joining a new team at Microsoft.
Even though I&rsquo;m moving within the company, this will be a completely new experience, and I&rsquo;m pumped.</p>

<h2>What I&rsquo;ve Been Doing</h2>

<p>A year and a half ago, I joined a top-notch team working on <a href="http://blog.jongallant.com/2013/03/new-job-hiring-devs.html">a super secret Win8 app</a>.
A week after I started, our project was cancelled.
Oops :)</p>

<p>Our team was part of the Bing Ads org structure, so after a few months of limbo, we took ownership of the management and authoring tools for display ads.
Getting to work with this team of hand-picked developers has been an amazing experience.
I&rsquo;ve learned a ton about Agile methodologies, TDD, DevOps, and more.</p>

<p>I got to contribute to many projects in my time on the team, but here are the things I&rsquo;m most proud of:</p>

<ul>
<li>Building a RESTful API for storing, transforming, searching, and serving image and video assets</li>
<li>Building a purely static Angular SPA, backed by Node.js microservices</li>
<li>Converting most of the team&rsquo;s codebase to Git on Visual Studio Online, with CI through Octopus</li>
<li>Becoming a team resource for Git and JavaScript domain knowledge</li>
</ul>


<h2>What&rsquo;s Next</h2>

<p>I&rsquo;m joining the &ldquo;Client Platform Tools&rdquo; team inside DevDiv.
They work on the TypeScript language and tooling, as well as the JavaScript tooling in Visual Studio, and the F12 tools in Internet Explorer.</p>

<p>I&rsquo;ll be working on JavaScript profiling and diagnostics (think CPU/memory usage and network calls).
This will be a new experience for me.
I&rsquo;ve spent most of the last year and a half writing JavaScript for either the browser or Node, but now I&rsquo;ll be stepping a little deeper and working on the development tools themselves.
I&rsquo;ll also be jumping into TypeScript, the language in which most of the tools are written.</p>

<p>Thinking about everything I&rsquo;m going to be learning about and working on, I&rsquo;m excited, optimistic, and honestly a little scared.</p>

<p><strong>But that&rsquo;s good</strong>.</p>

<p>If changing teams didn&rsquo;t move me outside my comfort zone, it&rsquo;d be the wrong move.</p>

<p>I&rsquo;ve found that there are two things that get me pumped about what I&rsquo;m working on.
The first is that it&rsquo;s challenging.
I love learning, and it turns out working on problems I don&rsquo;t quite know how to solve is a great way to learn.</p>

<p>The second thing I love is doing work that makes a difference.
I don&rsquo;t only mean that in an altruistic sense, but in a broader, &ldquo;makes someone&rsquo;s job/life easier&rdquo; kind of way.
That&rsquo;s why a developer tools team was so appealing to me, and why I&rsquo;m so excited about what the next chapter will bring.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Ignoring JavaScript Libraries While Debugging]]></title>
    <link href="http://willi.am/blog/2014/10/28/ignoring-javascript-libraries-while-debugging/"/>
    <updated>2014-10-28T14:33:06-07:00</updated>
    <id>http://willi.am/blog/2014/10/28/ignoring-javascript-libraries-while-debugging</id>
    <content type="html"><![CDATA[<p>Debugging front-end JavaScript can sometimes be painful.
When you rely on third-party libraries and frameworks, you find yourself stepping back and forth between the library&rsquo;s code and your own.
Most of the time, it&rsquo;s safe to assume that these third-party libraries are working correctly, so ignoring them can make it easier to keep your own code in your head.</p>

<p>Fortunately for us, Chrome, Firefox, and Internet Explorer each provide a way to ignore library code.</p>

<h3>Chrome</h3>

<p>In chrome, you can ignore a specific script by right clicking it in the &ldquo;Sources&rdquo; tab.</p>

<p><img src="http://itsananderson.blob.core.windows.net/post-images/chrome-blackbox-script.png" alt="" /></p>

<p>You can view the currently ignored patterns in the devtools settings page.</p>

<p><img src="http://itsananderson.blob.core.windows.net/post-images/chrome-blackbox-patterns.png" alt="" /></p>

<h3>Firefox</h3>

<p>Firefox is similar to Chrome, but you select the script in the &ldquo;Debugger&rdquo; tab, and click the eye icon to &ldquo;Toggle Black Boxing&rdquo;.</p>

<p><img src="http://itsananderson.blob.core.windows.net/post-images/firefox-blackbox-script.png" alt="" /></p>

<h3>Internet Explorer</h3>

<p>Internet explorer uses a different term, but the concept is the same.</p>

<p><img src="http://itsananderson.blob.core.windows.net/post-images/internet-explorer-mark-as-library.png" alt="" /></p>

<p>You can edit the exclusion list in:</p>

<p><code>%APPDATA%\..\LocalLow\Microsoft\F12\header\MyCode.json</code></p>

<p>or</p>

<p><code>%APPDATA%\..\Local\Microsoft\F12\header\MyCode.json</code></p>

<p>More info is available in the <a href="http://msdn.microsoft.com/en-us/library/ie/dn255007(v=vs.85).aspx#just_my_code">F12 tools documentation</a>.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Unpacking a Git Database]]></title>
    <link href="http://willi.am/blog/2014/10/14/unpacking-a-git-database/"/>
    <updated>2014-10-14T13:57:15-07:00</updated>
    <id>http://willi.am/blog/2014/10/14/unpacking-a-git-database</id>
    <content type="html"><![CDATA[<p>While writing the <a href="http://willi.am/blog/2014/10/14/for-the-last-time-git-stores-snapshots-not-diffs/">previous post</a>, I discovered a cool Git command which I thought I&rsquo;d share.</p>

<p>When you clone a Git repository, most Git hosts will send you a packed version of the database.
This is much more efficient than sending the raw Git objects, because duplicate content can be compressed.</p>

<p>However, if you want to inspect the object database with a file browser, it&rsquo;s hard to do so, because the content stays packed in a single file.
Unpacking is pretty simple.</p>

<p>If you unpack the <code>.pack</code> file while it&rsquo;s in the <code>.git/object/pack</code> folder, Git won&rsquo;t do anything, because it concludes that it already has all the objects contained in that <code>.pack</code>.
However, if you move the <code>.pack</code> file somewhere else, you can unpack it into your repository&rsquo;s database.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>mv .git/object/pack/pack-*.pack .
</span><span class='line'>cat pack-*.pack | git unpack-objects
</span><span class='line'>rm pack-*.pack</span></code></pre></td></tr></table></div></figure>


<p>And there you have it.
Your packed objects are unpacked into <code>.git/objects/</code> folder.</p>

<p>This isn&rsquo;t something I recommend doing as a general practice, since it can take up significantly more space, but it&rsquo;s a useful thing to be able to do if you want to manually inspect your Git database.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[For the Last Time: Git Stores Snapshots Not Diffs]]></title>
    <link href="http://willi.am/blog/2014/10/14/for-the-last-time-git-stores-snapshots-not-diffs/"/>
    <updated>2014-10-14T10:15:11-07:00</updated>
    <id>http://willi.am/blog/2014/10/14/for-the-last-time-git-stores-snapshots-not-diffs</id>
    <content type="html"><![CDATA[<p>I have this discussion every month or two, so it&rsquo;s finally time to write a blog post I can point people to instead.
<strong>Git stores a snapshot of the entire file, not a diff</strong></p>

<p>This is an understandable point of confusion, because most output from Git is in the form of diffs.
Additionally, many other SCMs store changes as diffs instead of snapshots.
However, Git stores an entire snapshot of each modified file.</p>

<p>If you want to see an explanation from someone much smarter than me, check out <a href="https://www.youtube.com/watch?v=rALm7BCCY-0#t=6m28s">this video</a>.</p>

<h2>Illustrating Snapshots</h2>

<p>The easiest way to show how Git stores snapshots is create a project and show the relative sizes of the .git object folder.</p>

<p>I&rsquo;ve created a <a href="https://github.com/itsananderson/alice">sample project on GitHub</a> that contains two commits.
The first commit introduces the text of Alice&rsquo;s Adventures in Wonderland.
The second commit makes a small modification to the text.</p>

<p>If you clone the repository and unpack the individual objects, you&rsquo;ll see something like the following when you inspect the .git directory with <a href="http://windirstat.info/">WinDirStat</a>.</p>

<p><img src="http://itsananderson.blob.core.windows.net/post-images/alice-windirstat.png" alt="" /></p>

<p>As you can see, Git stores two blobs of (nearly) identical size, one for each version of the text.
If Git stored diffs, you&rsquo;d expect to see one large blob, and a second much smaller blob (plus other objects for the tree etc.)</p>

<p>This isn&rsquo;t exactly a scientific proof about Git&rsquo;s behavior, but hopefully it illustrates it enough to get the point across.
If you want a more detailed explanation about how Git stores data, you can watch the YouTube video above, or read the Git documentation.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Understanding Node's require Function]]></title>
    <link href="http://willi.am/blog/2014/10/12/understanding-nodes-require-function/"/>
    <updated>2014-10-12T09:24:25-07:00</updated>
    <id>http://willi.am/blog/2014/10/12/understanding-nodes-require-function</id>
    <content type="html"><![CDATA[<p>I&rsquo;ve seen a few patterns lately that misunderstand Node&rsquo;s <code>require()</code> function, or simply fail to fully utilize it well.
Let&rsquo;s talk about some examples.</p>

<h2>Skipping the File Extension</h2>

<p>When you <code>require()</code> a file in Node, it checks a few possibilities:</p>

<ul>
<li>The exact file name</li>
<li>The file name with <code>.js</code> appended</li>
<li>The file name with <code>.json</code> appended</li>
</ul>


<p><em>Note: In case you weren&rsquo;t aware, Node has built-in support for <code>require</code>ing JSON files.
No need to manually read the file and call <code>JSON.parse</code>.</em></p>

<p>This means instead of doing <code>require('./foo.js')</code> you can do <code>require('./foo')</code>, and Node will figure it out.
I personally feel that it looks cleaner to leave off the file extension, but that&rsquo;s a matter of preference.
There is, however, at least one case I&rsquo;m aware of where leaving off the file extension improves the flexibility of your code.</p>

<p>Let&rsquo;s say you have a config for your app, stored in <code>config.json</code>.
Throughout your app you <code>require('./config.json')</code> to load the config.
Now what if you decide the config needs to execute dynamic code (to look up environment variables, for example)?
If you&rsquo;ve hardcoded the <code>.json</code> in your code, you&rsquo;ll have to find everywhere you&rsquo;ve used it and change the extension.</p>

<p>There are two ways to avoid this. The first is to just start with a <code>.js</code> file, even if it&rsquo;s a static config.
The second is to just <code>require('./config')</code> in your code, so that you can change the file extension without needing to update your code base.</p>

<h2>Modules Are Singletons</h2>

<p>When you load a module/file in Node, you&rsquo;ll always get the same instance.
Consider the following:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">// a.js</span>
</span><span class='line'><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">// main.js</span>
</span><span class='line'><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./a&#39;</span><span class="p">));</span>
</span><span class='line'><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./a&#39;</span><span class="p">));</span>
</span><span class='line'><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./a&#39;</span><span class="p">));</span>
</span><span class='line'><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./a&#39;</span><span class="p">));</span>
</span></code></pre></td></tr></table></div></figure>


<p>Intuitively, it seems like main.js would print 4 different random numbers, but it actually prints the same random number 4 times.
This is because Node will only load a file once.
If you <code>require</code> the same file multiple times (even from different parts of your code), you&rsquo;ll get the same instance.</p>

<p>I&rsquo;ve seen code passing around objects between modules when they could just require the file again and get the same result.
Obviously there are good reasons, like dependency injection, for passing objects around, but sometimes it adds useless complexity.
In cases where you&rsquo;re only passing required objects around &ldquo;to get the same instance&rdquo;, just require the module where it&rsquo;s needed.</p>

<p>Now the question you should be asking is &ldquo;what if I <em>do</em> want different instances?&rdquo;.
The answer is to export a function, which can then be invoked to get a new instance.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">// b.js</span>
</span><span class='line'><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">();</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">// main.js</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">rand</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./b&#39;</span><span class="p">);</span>
</span><span class='line'><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">rand</span><span class="p">());</span>
</span><span class='line'><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">rand</span><span class="p">());</span>
</span><span class='line'><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">rand</span><span class="p">());</span>
</span><span class='line'><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">rand</span><span class="p">());</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Don&rsquo;t Load a Module&rsquo;s Submodule</h2>

<p>This example is obscure. I&rsquo;ve only seen it once, but it was a pain.</p>

<p>You can <em>technically</em> do something like this: <code>require('some-module/node_modules/some-submodule')</code> to load a dependency of a module you depend on, but you shouldn&rsquo;t.</p>

<p>The problem with this approach is that you&rsquo;re inferring a contract with the module&rsquo;s code that isn&rsquo;t present.
The author of that module could easily switch out &ldquo;some-submodule&rdquo; for something else, without considering that a breaking change.
Depending on how you&rsquo;re pinning your versions, you may find yourself with an updated module and broken code.</p>

<p>Instead, stop being lazy and install &ldquo;some-submodule&rdquo; as a direct dependency.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Only Run One Suite or Spec in Jasmine]]></title>
    <link href="http://willi.am/blog/2014/09/25/only-run-one-suite-or-spec-in-jasmine/"/>
    <updated>2014-09-25T00:30:43-07:00</updated>
    <id>http://willi.am/blog/2014/09/25/only-run-one-suite-or-spec-in-jasmine</id>
    <content type="html"><![CDATA[<p>My team uses Karma (and thus Jasmine) to test our AngularJS applications.
Sometimes when a single test is failing, it&rsquo;s a pain to re-run every test while you iterate on a fix.</p>

<p>Turns out there&rsquo;s a way to only run a single suite of tests, or even a single test.</p>

<p>Suppose you have the following tests:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">describe</span><span class="p">(</span><span class="err">“</span><span class="nx">my</span> <span class="nx">feature</span> <span class="nx">a</span><span class="err">”</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">it</span><span class="p">(</span><span class="err">“</span><span class="nx">has</span> <span class="nx">a</span> <span class="nx">foo</span><span class="err">”</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// ...</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">it</span><span class="p">(</span><span class="err">“</span><span class="nx">has</span> <span class="nx">a</span> <span class="nx">bar</span><span class="err">”</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// ...</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="nx">describe</span><span class="p">(</span><span class="err">“</span><span class="nx">my</span> <span class="nx">feature</span> <span class="nx">b</span><span class="err">”</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">it</span><span class="p">(</span><span class="err">“</span><span class="nx">has</span> <span class="nx">a</span> <span class="nx">foo</span><span class="err">”</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// ...</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">it</span><span class="p">(</span><span class="err">“</span><span class="nx">has</span> <span class="nx">a</span> <span class="nx">bar</span><span class="err">”</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// ...</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you have tests failing in &ldquo;my feature a&rdquo;, you can just run those tests by changing the <code>describe</code> call to a <code>ddescribe</code> call.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">// Only this suite will run</span>
</span><span class='line'><span class="nx">ddescribe</span><span class="p">(</span><span class="err">“</span><span class="nx">my</span> <span class="nx">feature</span> <span class="nx">a</span><span class="err">”</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">it</span><span class="p">(</span><span class="err">“</span><span class="nx">has</span> <span class="nx">a</span> <span class="nx">foo</span><span class="err">”</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// ...</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">it</span><span class="p">(</span><span class="err">“</span><span class="nx">has</span> <span class="nx">a</span> <span class="nx">bar</span><span class="err">”</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// ...</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="nx">describe</span><span class="p">(</span><span class="err">“</span><span class="nx">my</span> <span class="nx">feature</span> <span class="nx">b</span><span class="err">”</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">it</span><span class="p">(</span><span class="err">“</span><span class="nx">has</span> <span class="nx">a</span> <span class="nx">foo</span><span class="err">”</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// ...</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">it</span><span class="p">(</span><span class="err">“</span><span class="nx">has</span> <span class="nx">a</span> <span class="nx">bar</span><span class="err">”</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// ...</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you&rsquo;ve narrowed down to a single spec, you can re-run that single spec by changing <code>it</code> to <code>iit</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">describe</span><span class="p">(</span><span class="err">“</span><span class="nx">my</span> <span class="nx">feature</span> <span class="nx">a</span><span class="err">”</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// Only this spec will run</span>
</span><span class='line'>    <span class="nx">iit</span><span class="p">(</span><span class="err">“</span><span class="nx">has</span> <span class="nx">a</span> <span class="nx">foo</span><span class="err">”</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// ...</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">it</span><span class="p">(</span><span class="err">“</span><span class="nx">has</span> <span class="nx">a</span> <span class="nx">bar</span><span class="err">”</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// ...</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="nx">describe</span><span class="p">(</span><span class="err">“</span><span class="nx">my</span> <span class="nx">feature</span> <span class="nx">b</span><span class="err">”</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">it</span><span class="p">(</span><span class="err">“</span><span class="nx">has</span> <span class="nx">a</span> <span class="nx">foo</span><span class="err">”</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// ...</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">it</span><span class="p">(</span><span class="err">“</span><span class="nx">has</span> <span class="nx">a</span> <span class="nx">bar</span><span class="err">”</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// ...</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you want to run multiple specs, you do that by simply changing each to <code>iit</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">describe</span><span class="p">(</span><span class="err">“</span><span class="nx">my</span> <span class="nx">feature</span> <span class="nx">a</span><span class="err">”</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// This spec will run</span>
</span><span class='line'>    <span class="nx">iit</span><span class="p">(</span><span class="err">“</span><span class="nx">has</span> <span class="nx">a</span> <span class="nx">foo</span><span class="err">”</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// ...</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">it</span><span class="p">(</span><span class="err">“</span><span class="nx">has</span> <span class="nx">a</span> <span class="nx">bar</span><span class="err">”</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// ...</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="nx">describe</span><span class="p">(</span><span class="err">“</span><span class="nx">my</span> <span class="nx">feature</span> <span class="nx">b</span><span class="err">”</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// This spec will run</span>
</span><span class='line'>    <span class="nx">iit</span><span class="p">(</span><span class="err">“</span><span class="nx">has</span> <span class="nx">a</span> <span class="nx">foo</span><span class="err">”</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// ...</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">it</span><span class="p">(</span><span class="err">“</span><span class="nx">has</span> <span class="nx">a</span> <span class="nx">bar</span><span class="err">”</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// ...</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>This was a pretty useful discovery for me. Hopefully it is for you as well.</p>

<p><strong>Update</strong>: <a href="http://davidruttka.com">David Ruttka</a> has pointed out that you can also use <code>xdescribe</code> and <code>xit</code> to <em>disable</em> individual suites and tests.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Use Blob Storage For Your Static Site Images]]></title>
    <link href="http://willi.am/blog/2014/09/24/use-blob-storage-for-your-static-site-images/"/>
    <updated>2014-09-24T01:37:53-07:00</updated>
    <id>http://willi.am/blog/2014/09/24/use-blob-storage-for-your-static-site-images</id>
    <content type="html"><![CDATA[<p>The purpose of this post is to show how easy it is to use cloud storage for your static blog&rsquo;s binary resources.
I&rsquo;ll be showing specific examples for Azure Blob Storage and GitHub Pages, but the same principles should apply to AWS, as well as any other static blogging service.</p>

<h2>Avoid Large Binaries in Git</h2>

<p>When ever you check a file (or a change to an existing file) into Git, it stores a snapshot of the entire file.
This behavior has many nice benefits, but it means that large files can quickly bloat the size of a Git repository.</p>

<p>Culprits can include images, videos, and executables, to name a few.
Since we&rsquo;re specifically talking about static blogging, we&rsquo;ll focus on images.</p>

<p>Suppose you add an image to your post.
If the image takes up 200KB, you&rsquo;re automatically increasing your repository size by around 200KB (ignoring extra Git metadata).
Every time you modify that image, you&rsquo;re adding yet another 200KB.
Doing this for a few dozen blog posts can quickly balloon your repo.</p>

<p>Now imaging doing this with a GIF instead. Yikes.</p>

<h2>Move Your Images To Blob Storage</h2>

<p>I&rsquo;m not going to cover redirecting existing images to blob storage.
When I switched over, I had few enough images that I just decided to manually update the posts that referenced them.
If you have enough images, it may not be reasonable to manually update the posts that reference them. In that case, you can either try to automate it with a glorified perl script, or just leave the old posts alone and just upload new images to blob storage.</p>

<p>If you&rsquo;re using Azure for your images, you&rsquo;ll want to grab a copy of <a href="http://azurestorageexplorer.codeplex.com/">Azure Storage Explorer</a>. It&rsquo;s a handy little Windows application that gives you a CRUD view into your storage account. My <a href="http://willi.am/blog/2014/07/01/azure-blob-storage-and-node-first-steps/">series on Azure Blob Storage and Node</a> covers setting up your storage account and getting your access keys, so I won&rsquo;t go over that again. Just grab one of your access keys and paste it into the &ldquo;Storage account key&rdquo; field in Storage Explorer&rsquo;s &ldquo;Add Storage Account&rdquo; popup.</p>

<p><img src="http://itsananderson.blob.core.windows.net/post-images/setup-storage-explorer.png" alt="" /></p>

<p>As a last configuration step, open Tools &rarr; Options and go to the &ldquo;Content Types&rdquo; tab, then click &ldquo;Save Changes&rdquo;. Storage Explorer can automatically set content types based on file extensions, but for some reason it&rsquo;s not enabled by default. Opening and saving the options seems to be enough to activate it.</p>

<p><img src="http://itsananderson.blob.core.windows.net/post-images/configure-storage-explorer.png" alt="" /></p>

<p>Now that you&rsquo;ve configured Storage Explorer, you can upload your images. First, create a container. Make sure you set permissions to &ldquo;Public Container&rdquo; or &ldquo;Public Blob&rdquo; so the images can be seen by unauthenticated users.</p>

<p>Now, inside the container, click &ldquo;Upload&rdquo;. You can select multiple images. Once they&rsquo;ve uploaded, double check that their content types are correct. The default is application/octet-stream, which most browsers will try to download, rather than display as an image. The public URL for a given image is pretty easy to get from the storage account, container, and blob name, but if you&rsquo;re not sure, just double click the blob, and it&rsquo;ll show you the public URL.</p>

<p>That&rsquo;s about it. Happy blogging.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Introducing Edge-Git]]></title>
    <link href="http://willi.am/blog/2014/09/16/introducing-edge-git/"/>
    <updated>2014-09-16T22:50:30-07:00</updated>
    <id>http://willi.am/blog/2014/09/16/introducing-edge-git</id>
    <content type="html"><![CDATA[<p>I&rsquo;ve recently been frustrated by the lack of functional Node bindings for <a href="https://libgit2.github.com/">libgit2</a>.
The most prominent projects are <a href="https://github.com/libgit2/node-gitteh">node-gitteh</a> and <a href="">nodegit</a>.
Unfortunately both repositories are severely lacking in features and documentation.
I couldn&rsquo;t even install node-gitteh on Windows, and I spent an unsuccessful evening trying to get nodegit to do something as simple as fetching changes.</p>

<p>Eventually I came to the conclusion that no libgit2 bindings for Node are functional enough for my use.</p>

<p>I&rsquo;d used <a href="https://github.com/libgit2/libgit2sharp">LibGit2Sharp</a> for a .NET project in the past.
It&rsquo;s an amazingly high-quality project.
While the documentation is sparse, the copious unit tests make it easy to figure out how to accomplish different tasks.</p>

<p>I&rsquo;d read about <a href="http://tjanczuk.github.io/edge/">Edge.js</a>, which lets you interop between .NET and Node, but hadn&rsquo;t actually done anything with it.
Since I had a seemingly perfect use case, I decided to dive in.</p>

<p>About a week later, I have a very basic initial release of <a href="https://www.npmjs.org/package/edge-git">edge-git.</a>
About all you can do at this point is init, clone, and query branches/commits, but I&rsquo;m steadily adding more bindings to the existing LibGit2Sharp functionality.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Gulp Automation: Path Abstraction]]></title>
    <link href="http://willi.am/blog/2014/08/16/gulp-automation-path-abstraction/"/>
    <updated>2014-08-16T00:57:44-07:00</updated>
    <id>http://willi.am/blog/2014/08/16/gulp-automation-path-abstraction</id>
    <content type="html"><![CDATA[<p>If you use Gulp for anything more than a trivial project, you&rsquo;ll find that you reference paths <em>a lot</em>.
Paths for sources, paths for destinations.
Paths to watch for changes.
You get the picture.</p>

<p>Without some organization, things can quickly get out of hand.</p>

<h2>Store Paths In Variables</h2>

<p>As tempting as it might be to shove an extra path into a task definition, resist the urge.
Instead, define your paths as variables.
This allows you to share and compose path groups without repetition.</p>

<p>As an example, consider a common use case.
You want to lint your JavaScript for your application code and tests, but you only want to minify your application code and run tests against your test code.
You could approach it like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="s1">&#39;lint&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">gulp</span><span class="p">.</span><span class="nx">src</span><span class="p">([</span><span class="s1">&#39;app/*.js&#39;</span><span class="p">,</span> <span class="s1">&#39;test/*.js&#39;</span><span class="p">])</span>
</span><span class='line'>        <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">lint</span><span class="p">());</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="s1">&#39;minify&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">gulp</span><span class="p">.</span><span class="nx">src</span><span class="p">([</span><span class="s1">&#39;app/*.js&#39;</span><span class="p">])</span>
</span><span class='line'>        <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">lint</span><span class="p">());</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">gulp</span><span class="p">.</span><span class="nx">src</span><span class="p">([</span><span class="s1">&#39;test/*.js&#39;</span><span class="p">])</span>
</span><span class='line'>        <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">lint</span><span class="p">());</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>This isn&rsquo;t bad, but things can quickly get out of hand.
At this point already, if you moved your application code to a folder called &lsquo;src&rsquo;, you&rsquo;d have to update your gulpfile in two places.
Three if you&rsquo;d added a &lsquo;watch&rsquo; task.</p>

<p>When you abstract your paths, you can reuse them throughout your gulpfile.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">appPaths</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;app/*.js&#39;</span><span class="p">];</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">testPaths</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;test/*.js&#39;</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'><span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="s1">&#39;lint&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">gulp</span><span class="p">.</span><span class="nx">src</span><span class="p">(</span><span class="nx">appPaths</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">testPaths</span><span class="p">))</span>
</span><span class='line'>        <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">lint</span><span class="p">());</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="s1">&#39;minify&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">gulp</span><span class="p">.</span><span class="nx">src</span><span class="p">(</span><span class="nx">appPaths</span><span class="p">)</span>
</span><span class='line'>        <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">minify</span><span class="p">());</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">gulp</span><span class="p">.</span><span class="nx">src</span><span class="p">(</span><span class="nx">testPaths</span><span class="p">)</span>
</span><span class='line'>        <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">test</span><span class="p">());</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>Again, this is a simple example, but hopefully it illustrates the point.</p>

<h2>Breaking Into <code>require</code>able Pieces</h2>

<p>Once your paths are in variables, you can abstract them further by putting them their own file.</p>

<p>To illustrate, suppose you have Karma tests.
Karma uses its own configuration file, but gulp-karma overrides some if them, which can make it hard to avoid duplicating configurations.
Consider the following config:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">// karma.conf.js</span>
</span><span class='line'><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">config</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">config</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span>
</span><span class='line'>        <span class="nx">files</span><span class="o">:</span> <span class="p">[</span>
</span><span class='line'>            <span class="s1">&#39;vendor/angular.js&#39;</span><span class="p">,</span>
</span><span class='line'>            <span class="s1">&#39;app/*.js&#39;</span><span class="p">,</span>
</span><span class='line'>            <span class="s1">&#39;test/*.js&#39;</span>
</span><span class='line'>        <span class="p">],</span>
</span><span class='line'>        <span class="nx">reporters</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;spec&#39;</span><span class="p">],</span>
</span><span class='line'>        <span class="nx">autoWatch</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">frameworks</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;jasmine&#39;</span><span class="p">],</span>
</span><span class='line'>        <span class="nx">browsers</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;PhantomJS&#39;</span><span class="p">],</span>
</span><span class='line'>        <span class="nx">plugins</span><span class="o">:</span> <span class="p">[</span>
</span><span class='line'>            <span class="s1">&#39;karma-jasmine&#39;</span><span class="p">,</span>
</span><span class='line'>            <span class="s1">&#39;karma-spec-reporter&#39;</span><span class="p">,</span>
</span><span class='line'>            <span class="s1">&#39;karma-phantomjs-launcher&#39;</span>
</span><span class='line'>        <span class="p">],</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>Not too bad, but again, we&rsquo;re duplicating logic.
Back in the gulpfile, we&rsquo;ll have a task like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">vendorPaths</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;vendor/angular.js&#39;</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'><span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="s1">&#39;karma&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">gulp</span><span class="p">.</span><span class="nx">src</span><span class="p">(</span><span class="nx">vendorPaths</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">appPaths</span><span class="p">).</span><span class="nx">concat</span><span class="p">(</span><span class="nx">testPaths</span><span class="p">))</span>
</span><span class='line'>        <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">karma</span><span class="p">({</span> <span class="nx">configFile</span><span class="o">:</span> <span class="s1">&#39;karma.conf.js&#39;</span> <span class="p">}));</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>Suddenly, there&rsquo;s path duplication between the Karma config file and the gulpfile.
To fix this, simply define your paths in another file that&rsquo;s included by both.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;app/*.js&#39;</span><span class="p">];</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">test</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;test/*.js&#39;</span><span class="p">];</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">vendor</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;vendor/angular.js&#39;</span><span class="p">];</span>
</span><span class='line'><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">app</span><span class="o">:</span> <span class="nx">app</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">test</span><span class="o">:</span> <span class="nx">test</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">vendor</span><span class="o">:</span> <span class="nx">vendor</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">karma</span><span class="o">:</span> <span class="nx">vendor</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">app</span><span class="p">).</span><span class="nx">concat</span><span class="p">(</span><span class="nx">test</span><span class="p">)</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then your gulpfile should look like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">paths</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./paths&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="s1">&#39;lint&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">gulp</span><span class="p">.</span><span class="nx">src</span><span class="p">(</span><span class="nx">paths</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">paths</span><span class="p">.</span><span class="nx">test</span><span class="p">))</span>
</span><span class='line'>        <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">lint</span><span class="p">());</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="s1">&#39;minify&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">gulp</span><span class="p">.</span><span class="nx">src</span><span class="p">(</span><span class="nx">paths</span><span class="p">.</span><span class="nx">app</span><span class="p">)</span>
</span><span class='line'>        <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">minify</span><span class="p">());</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">gulp</span><span class="p">.</span><span class="nx">src</span><span class="p">(</span><span class="nx">paths</span><span class="p">.</span><span class="nx">test</span><span class="p">)</span>
</span><span class='line'>        <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">test</span><span class="p">());</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="s1">&#39;karma&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">gulp</span><span class="p">.</span><span class="nx">src</span><span class="p">(</span><span class="nx">paths</span><span class="p">.</span><span class="nx">karma</span><span class="p">)</span>
</span><span class='line'>        <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">karma</span><span class="p">({</span> <span class="nx">configFile</span><span class="o">:</span> <span class="s1">&#39;karma.conf.js&#39;</span> <span class="p">}));</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>And your karma.conf.js can look like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">// karma.conf.js</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">paths</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./paths&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">config</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">config</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span>
</span><span class='line'>        <span class="nx">files</span><span class="o">:</span> <span class="nx">paths</span><span class="p">.</span><span class="nx">karma</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">reporters</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;spec&#39;</span><span class="p">],</span>
</span><span class='line'>        <span class="nx">autoWatch</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">frameworks</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;jasmine&#39;</span><span class="p">],</span>
</span><span class='line'>        <span class="nx">browsers</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;PhantomJS&#39;</span><span class="p">],</span>
</span><span class='line'>        <span class="nx">plugins</span><span class="o">:</span> <span class="p">[</span>
</span><span class='line'>            <span class="s1">&#39;karma-jasmine&#39;</span><span class="p">,</span>
</span><span class='line'>            <span class="s1">&#39;karma-spec-reporter&#39;</span><span class="p">,</span>
</span><span class='line'>            <span class="s1">&#39;karma-phantomjs-launcher&#39;</span>
</span><span class='line'>        <span class="p">],</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>There you have it.
Nice and DRY.</p>

<p>Here&rsquo;s a <a href="https://gist.github.com/itsananderson/61bad88e4470679a4f13">Gist of the completed example</a>.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[The Dark Side of the Force Push]]></title>
    <link href="http://willi.am/blog/2014/08/12/the-dark-side-of-the-force-push/"/>
    <updated>2014-08-12T23:26:08-07:00</updated>
    <id>http://willi.am/blog/2014/08/12/the-dark-side-of-the-force-push</id>
    <content type="html"><![CDATA[<p>Let&rsquo;s talk about force pushing in Git.
We&rsquo;ll cover when you should do it, when you shouldn&rsquo;t, and how to do it safely.</p>

<p>TL;DR</p>

<p>Do this:</p>

<p><img src="http://itsananderson.blob.core.windows.net/post-images/obi-wan-droids.gif" alt="Force Push Droids" /></p>

<p>Not this:</p>

<p><img src="http://itsananderson.blob.core.windows.net/post-images/obi-wan-hates.gif" alt="Force Push Fail" /></p>

<h2>Pushing Changes</h2>

<p>When you push changes to a remote server, Git prevents you from pushing your changes if the remote has changes you&rsquo;re missing.
This feature is designed to prevent data loss.
If you run into this, you&rsquo;ll likely see a message similar to this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ git push origin my-branch
</span><span class='line'>To git@github.com:itsananderson/foo.git
</span><span class='line'> ! [rejected]        my-branch -&gt; my-branch (non-fast-forward)
</span><span class='line'>error: failed to push some refs to 'git@github.com:itsananderson/foo.git'
</span><span class='line'>hint: Updates were rejected because the tip of your current branch is behind
</span><span class='line'>hint: its remote counterpart. Integrate the remote changes (e.g.
</span><span class='line'>hint: 'git pull ...') before pushing again.
</span><span class='line'>hint: See the 'Note about fast-forwards' in 'git push --help' for details.</span></code></pre></td></tr></table></div></figure>


<p>99% of the time, the appropriate solution to this message is to <code>git pull</code> to fetch changes from the server,
then <code>git push origin my-branch</code> to push your updated branch to the server.</p>

<h2>Rebasing</h2>

<p>The only real exception to the &ldquo;always pull, then push&rdquo; rule, is rebasing.
When you rebase, you&rsquo;re creating a copy of your commit history.
Git treats this new copy of history as a completely different set of commits (because it is).</p>

<p>I won&rsquo;t go into deep detail about rebasing, because it&rsquo;s been covered many times before.
GitHub has a good <a href="https://help.github.com/articles/using-git-rebase">tutorial on rebasing</a>.
If you want some <a href="http://willi.am/git-fundamentals-rebasing/">high-level concept slides on rebasing</a>, I wrote some for a team presentation.</p>

<p>Point is, when you rebase a branch that you&rsquo;ve pushed to a remote server, your copy of the branch and the server&rsquo;s copy will be considered completely distinct.
This means when you try to push, the remote server will reject your changes because they&rsquo;re not a fast-forward.
However, if you <code>git pull</code>, you&rsquo;ll end up with two copies of the branch which are then merged with a merge commit.
In addition to muddling your commit history, this will re-introduce whatever you were trying to change with your rebase.</p>

<p>In this very specific case, the correct solution <em>might</em> be to <code>git push origin my-branch -f</code>.</p>

<h2>Force Push Basics</h2>

<p>So you have a branch that you&rsquo;ve rebased, and you want to force push it to the remote server.</p>

<p><img src="http://itsananderson.blob.core.windows.net/post-images/force-push-will-smith.gif" alt="Will Smith Force Push" /></p>

<p>First, make sure nobody&rsquo;s pulled down your branch and done local work off of it.
If they have, your force push may make it difficult for them to reconcile their changes with yours.</p>

<p>If you&rsquo;re working on a team and need to rebase a shared branch, here are the steps:</p>

<ol>
<li>Make sure your team has committed and pushed any pending changes</li>
<li>Ask your team to pause work on that branch temporarily</li>
<li>Make sure you have the latest changes for that branch (git pull)</li>
<li>Rebase, then <code>git push origin &lt;yourbranch&gt; -f</code></li>
<li>Have your team fix up their local branches with <code>git checkout &lt;yourbranch&gt;</code>, <code>git fetch</code> and <code>git reset --hard origin/&lt;yourbranch&gt;</code></li>
</ol>


<p>As you can see, this is a complicated process.
It requires team coordination, and potentially blocks team members from doing work while you rebase.
As a general rule, avoid rebasing or otherwise modifying history on pushed branches unless you&rsquo;ve accidentally published <a href="https://help.github.com/articles/remove-sensitive-data">sensitive data</a>.</p>

<p>If you&rsquo;re working alone, the process is a little simpler.
Simply rebase and then <code>git push origin &lt;yourbranch&gt; -f</code>.
Keep in mind, however, that you may still cause headaches for other people if you rebase on a public GitHub (Bitbucket, etc.) repository.</p>

<h2>Aside: Understanding Remote Tracking Branches</h2>

<p>Git uses the concept of remote tracking branches (or branch upstreams) to help you associate your local branches with the branches on remote servers.
If you&rsquo;ve ever seen this message, that&rsquo;s what it&rsquo;s talking about: <code>Branch my-branch set up to track remote branch my-branch origin.</code></p>

<p>Additionally, if you&rsquo;ve seen this message when you ran <code>git status</code>, it means your branch is tracking a remote branch:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>On branch my-branch
</span><span class='line'>Your branch and 'origin/my-branch' have diverged,
</span><span class='line'>and have 5 and 2 different commit each, respectively.</span></code></pre></td></tr></table></div></figure>


<p>Finally, when you run <code>git pull</code> or <code>git push</code>, Git can use the remote tracking branch to know which remote branch to interact with.
This keeps you from having to type <code>git pull origin my-branch</code> every time.</p>

<p>There&rsquo;s a blog post with more info on <a href="http://felipec.wordpress.com/2013/09/01/advanced-git-concepts-the-upstream-tracking-branch/">remote tracking branches and upstreams</a>.</p>

<h2>Force Push Pitfalls</h2>

<p>When you start force pushing, there are a few pitfalls you should be aware of.</p>

<p><img src="http://itsananderson.blob.core.windows.net/post-images/force-push-yoda.gif" alt="Yoda Force Push" /></p>

<h3>Overwriting Changes</h3>

<p>Before you force push a branch, double check that nobody has pushed new changes to that branch.
If they have, and you don&rsquo;t pull them in, you&rsquo;ll overwrite them when you force push.</p>

<p>With online source control, you can just browse the repository and check the commit history for your branch.</p>

<p>If you don&rsquo;t have a web UI, you can also check directly in the source.</p>

<ol>
<li>Run <code>git fetch</code> to pull down the latest changes to your machine</li>
<li>Run <code>git log origin/&lt;yourbranch&gt;</code> to remote branch&rsquo;s log</li>
<li>If you don&rsquo;t see any new commits, it&rsquo;s probably safe to proceed (ignoring developer race conditions)</li>
<li>If you see new changes, resolve them into your local branch before you force push</li>
</ol>


<p>As with software, you can run into a race condition.
If somebody pushes changes between when you fetch and when you push, you may still overwrite them.
To avoid this, communicate with your team.
A simple &ldquo;don&rsquo;t push anything on <yourbranch> for a minute&rdquo;, followed up by an &ldquo;all clear&rdquo; should do the trick.</p>

<h3>Overwriting Other Branches</h3>

<p>When you push and pull, Git can use remote tracking branches (see above) to infer which remote branch you want to push/pull from.
This is generally ok for normal push/pull activity, but when you force push, it can be dangerous.</p>

<p>By default, Git responds to <code>git push</code> by pushing <em>all</em> branches that exist on both your local machine and the remote server.
This means, if you have commits on master and my-feature-branch, and you run <code>git push</code>, it will push your changes from both branches at once.</p>

<p>In Git 2.0, this behavior was changed to only push the current branch, but older versions still have this unexpected behavior.
To fix it, run the following command:</p>

<p><code>git config --global push.default simple</code></p>

<p>Now if you run <code>git push</code>, it will only try to push your current branch.</p>

<p>The default push behavior becomes especially dangerous when you force push.
If, for example, you run <code>git push -f</code>, and your master branch is behind the remote server&rsquo;s master,
you may accidentally remove commits from master.</p>

<p>For this reason, I recommend two things:</p>

<ol>
<li>Configure push.default with the safer <code>simple</code> setting</li>
<li>Always explicitly state the remote and branch name when you force push: <code>git push -f origin my-feature-branch</code></li>
</ol>


<h2>In Conclusion</h2>

<p>Hopefully this gives you a good overview of the how/why/when of force pushing.</p>

<p>If you haven&rsquo;t already, be sure to read the section on force push pitfalls.
They&rsquo;re important to understand, and they&rsquo;re the main reason I wrote this post.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Test Your API With Supertest]]></title>
    <link href="http://willi.am/blog/2014/07/28/test-your-api-with-supertest/"/>
    <updated>2014-07-28T14:18:23-07:00</updated>
    <id>http://willi.am/blog/2014/07/28/test-your-api-with-supertest</id>
    <content type="html"><![CDATA[<p>I recently discovered <a href="https://npmjs.org/package/supertest">supertest</a>, which is a fantastic tool for testing your API.
Despite being new to me, the package has been around for about 2 years.</p>

<h2>Setup</h2>

<p>You can configure supertest in a couple ways.
If you&rsquo;re testing an external site, you can configure supertest with the site&rsquo;s base url:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">request</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;supertest&#39;</span><span class="p">)(</span><span class="s1">&#39;http://example.com/&#39;</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you&rsquo;re testing an Express app, you can pass the app to supertest, and let it worry about setup/teardown of your site.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">myApp</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../app.js&#39;</span><span class="p">);</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">request</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;supertest&#39;</span><span class="p">)(</span><span class="nx">myApp</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>The great thing about this approach is that supertest takes care of starting up and shutting down your site on a random port.
This allows you to just write your tests, without worrying about starting apps, conflicting ports, etc.</p>

<h2>Writing a Test</h2>

<p>Once you&rsquo;ve imported supertest, it&rsquo;s quite simple to use.
In my examples, I&rsquo;ll be using the test framework provided by <a href="https://npmjs.org/package/mocha">Mocha</a>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;my api&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;returns hello world&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">request</span><span class="p">.</span>
</span><span class='line'>            <span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
</span><span class='line'>            <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="s1">&#39;Hello, World!&#39;</span><span class="p">,</span> <span class="nx">done</span><span class="p">);</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is about as simple as the tests get.
We call the root of the site, and expect the response body to equal &ldquo;Hello, World!&rdquo;.</p>

<p>Since the request is async, we take in a &ldquo;done&rdquo; parameter (which Mocha passes to us).
We call that at the end of the test when we&rsquo;ve actually had a chance to verify the server response.</p>

<p>You can easily test a JSON response with supertest:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">request</span><span class="p">.</span>
</span><span class='line'>    <span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="p">.</span><span class="nx">expect</span><span class="p">({</span><span class="nx">message</span><span class="o">:</span> <span class="s2">&quot;Hello, World!&quot;</span><span class="p">},</span> <span class="nx">done</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Headers are also simple to verify.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">request</span><span class="p">.</span>
</span><span class='line'>    <span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/foo&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="s1">&#39;application/json&#39;</span><span class="p">,</span> <span class="nx">done</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Status codes are even easier.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">request</span>
</span><span class='line'>    <span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/some-error-route&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="s1">&#39;Oops. Something went wrong&#39;</span><span class="p">,</span> <span class="nx">done</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>You can do non-GET requests.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">user</span> <span class="o">=</span> <span class="p">{</span><span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Bob&#39;</span><span class="p">};</span>
</span><span class='line'><span class="nx">request</span>
</span><span class='line'>    <span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">&#39;/create-user&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">user</span><span class="p">)</span>
</span><span class='line'>    <span class="p">.</span><span class="nx">expect</span><span class="p">({</span><span class="nx">success</span><span class="o">:</span><span class="kc">true</span><span class="p">},</span> <span class="nx">done</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>You can set headers for the request.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">request</span>
</span><span class='line'>    <span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/foo&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;Accept&#39;</span><span class="p">,</span> <span class="s1">&#39;text/plain&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="s1">&#39;text/plain&#39;</span><span class="p">,</span> <span class="nx">done</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>You can match regular expressions against headers and bodies.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">request</span>
</span><span class='line'>    <span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/redirect&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="s1">&#39;Location&#39;</span><span class="o">:</span> <span class="sr">/\/destination/</span><span class="p">)</span>
</span><span class='line'>    <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">301</span><span class="p">,</span> <span class="nx">done</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you need to do multiple requests in series, you can chain the &ldquo;expect&rdquo; callbacks:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">// Kick things off</span>
</span><span class='line'><span class="nx">purgeUsers</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">purgeUsers</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">request</span>
</span><span class='line'>        <span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/users/purge&#39;</span><span class="p">)</span>
</span><span class='line'>        <span class="p">.</span><span class="nx">expect</span><span class="p">({</span><span class="nx">success</span><span class="o">:</span><span class="kc">true</span><span class="p">},</span> <span class="nx">checkNoUsers</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">checkNoUsers</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="nx">done</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">request</span>
</span><span class='line'>        <span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/users&#39;</span><span class="p">)</span>
</span><span class='line'>        <span class="p">.</span><span class="nx">expect</span><span class="p">([],</span> <span class="nx">addUser</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">addUser</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="nx">done</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">request</span>
</span><span class='line'>        <span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">&#39;/users&#39;</span><span class="p">)</span>
</span><span class='line'>        <span class="p">.</span><span class="nx">send</span><span class="p">({</span><span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Bob&#39;</span><span class="p">})</span>
</span><span class='line'>        <span class="p">.</span><span class="nx">expect</span><span class="p">({</span><span class="nx">success</span><span class="o">:</span><span class="kc">true</span><span class="p">},</span> <span class="nx">checkUsers</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">checkUsers</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="nx">done</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">request</span>
</span><span class='line'>        <span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/users&#39;</span><span class="p">)</span>
</span><span class='line'>        <span class="p">.</span><span class="nx">expect</span><span class="p">([{</span><span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Bob&#39;</span><span class="p">}],</span> <span class="nx">done</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Finally, if you need to do some custom processing on a result, use the <code>.end()</code> function.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">assert</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;assert&#39;</span><span class="p">);</span>
</span><span class='line'><span class="nx">request</span>
</span><span class='line'>    <span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/foo&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">foo</span><span class="p">,</span> <span class="s1">&#39;Bar&#39;</span><span class="p">);</span>
</span><span class='line'>        <span class="nx">done</span><span class="p">();</span>
</span><span class='line'>    <span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>There are probably more features that I&rsquo;m not aware of, but this is a rundown of the ones I&rsquo;m most familiar with.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Storing Data as Newline Delimited JSON Entries]]></title>
    <link href="http://willi.am/blog/2014/07/16/storing-data-as-newline-delimited-json-entries/"/>
    <updated>2014-07-16T13:48:29-07:00</updated>
    <id>http://willi.am/blog/2014/07/16/storing-data-as-newline-delimited-json-entries</id>
    <content type="html"><![CDATA[<p>You can store data as newline delimited JSON entries.
Since JSON encodes newline characters, you can use newlines to separate entries.</p>

<p>For more details, read on.</p>

<h2>Exporting Large Data</h2>

<p>In a recent project, I needed to export data, and then import it into another system.
I decided to go with JSON as the export format, because it was structured data.
The problem was, the data could be extremely large, so loading it all into memory and generating a single JSON object wasn&rsquo;t an option.</p>

<p>As a first solution to the problem, I considered &ldquo;fake&rdquo; streaming to the file with the following pseudocode:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>open the file
</span><span class='line'>write "["
</span><span class='line'>foreach entry:
</span><span class='line'>  if not first entry:
</span><span class='line'>      write ","
</span><span class='line'>  write JSON serialized entry
</span><span class='line'>write "]"
</span><span class='line'>close the file</span></code></pre></td></tr></table></div></figure>


<p>This got the job done, but what about when I import the data?
Since I wrote the data as one giant JSON array, I&rsquo;d have to load the entire thing to deserialize.
(In Node, I could use a streaming JSON parser, but this project was in PHP).</p>

<p>This means there&rsquo;s a limit to the amount of data I can import.
Even on a host where I can control PHP&rsquo;s memory limit, there&rsquo;s still a limitation to how much data can reasonably be loaded into memory.</p>

<h2>Exporting Newline Delimited Data</h2>

<p>I finally realized that I was missing something important.
JSON serializes newlines as &ldquo;\n&rdquo;, which means actual newlines can be safely used to delimit each JSON entry.
(Assuming you don&rsquo;t &ldquo;pretty print&rdquo; your JSON).</p>

<p>The new export method is as follows:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>open the file
</span><span class='line'>foreach entry:
</span><span class='line'>  if not first entry:
</span><span class='line'>      write newline
</span><span class='line'>  write JSON serialized entry
</span><span class='line'>close the file</span></code></pre></td></tr></table></div></figure>


<p>Already simpler. Yay.</p>

<h2>Importing Newline Delimited Data</h2>

<p>Now that we&rsquo;ve exported the data, it&rsquo;s time to import it.
In PHP, this is still a challenge, because there&rsquo;s no elegant solution for streams.
The closest you can get is the <a href="http://php.net/manual/en/function.stream-get-line.php"><code>stream_get_line</code></a> function.
The problem with this function is that you have to specify a max length of characters to read.
If the line is longer than those characters, you have to detect that, and keep searching until you get to the newline.
There&rsquo;s a <a href="http://php.net/manual/en/function.stream-get-line.php#109339">comment on the manual that outlines the solution</a>.</p>

<p>In pseudocode:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>open the file
</span><span class='line'>while get line from file:
</span><span class='line'>  import entry
</span><span class='line'>close the file</span></code></pre></td></tr></table></div></figure>


<p>Again, fairly simple (ignoring caveats with &ldquo;get line from file&rdquo;).
The great thing about this solution is that we only have to load at most one entry at a time into memory.</p>

<h2>Bonus: Inspecting JSON Data From CLI</h2>

<p>If you want to inspect the data that you&rsquo;ve exported, you can use the handy &ldquo;<a href="http://npmjs.org/package/json">json</a>&rdquo; tool (requires Node).
Not only does it pretty print, but it allows you to pull out specific data, and supports newline delimited JSON entries with the <code>-g</code> flag.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat test.json
</span><span class='line'>{"name":"alice"}
</span><span class='line'>{"name":"bob"}
</span><span class='line'>{"name":"eve"}</span></code></pre></td></tr></table></div></figure>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat test.json | json -g
</span><span class='line'>[
</span><span class='line'>  {
</span><span class='line'>    "name": "alice"
</span><span class='line'>  },
</span><span class='line'>  {
</span><span class='line'>    "name": "bob"
</span><span class='line'>  },
</span><span class='line'>  {
</span><span class='line'>    "name": "eve"
</span><span class='line'>  }
</span><span class='line'>]</span></code></pre></td></tr></table></div></figure>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat test.json | json -ga name
</span><span class='line'>alice
</span><span class='line'>bob
</span><span class='line'>eve</span></code></pre></td></tr></table></div></figure>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat test.json | json -ga nameLength name -e 'this.nameLength = this.name.length'
</span><span class='line'>5 alice
</span><span class='line'>3 bob
</span><span class='line'>3 eve</span></code></pre></td></tr></table></div></figure>


<p><a href="http://trentm.com/json/">Full Documentation</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Azure Blob Storage and Node: All Together]]></title>
    <link href="http://willi.am/blog/2014/07/09/azure-blob-storage-and-node-all-together/"/>
    <updated>2014-07-09T21:16:08-07:00</updated>
    <id>http://willi.am/blog/2014/07/09/azure-blob-storage-and-node-all-together</id>
    <content type="html"><![CDATA[<p><strong>This is part of a series on working with Azure Blob Storage in Node.</strong></p>

<ol>
<li><a href="http://willi.am/blog/2014/06/30/azure-blob-storage-and-node/">Introduction</a></li>
<li><a href="http://willi.am/blog/2014/07/01/azure-blob-storage-and-node-first-steps/">First Steps</a></li>
<li><a href="http://willi.am/blog/2014/07/02/azure-blob-storage-and-node-creating-blobs/">Creating Blobs</a></li>
<li><a href="http://willi.am/blog/2014/07/03/azure-blob-storage-and-node-downloading-blobs/">Downloading Blobs</a></li>
<li><a href="http://willi.am/blog/2014/07/07/azure-blob-storage-and-node-listing-blobs/">Listing Blobs</a></li>
<li><a href="http://willi.am/blog/2014/07/08/azure-blob-storage-and-node-blob-metadata/">Blob Metadata</a></li>
<li><strong>All Together</strong></li>
</ol>


<h1>Building a Complete Service Over Azure Blob Storage</h1>

<p>In the last post, we covered <a href="blog/2014/07/08/azure-blob-storage-and-node-blob-metadata/">working with blob metadata</a>.
In this final post, we&rsquo;ll talk about putting all the previous pieces together to create a service that is backed by blob storage.</p>

<p>As a concrete example, we&rsquo;ll implement the image serving portion of <a href="http://placebacon.net/">placebacon</a>.
To keep things simple, we won&rsquo;t go into the Jade views, just the part that actually serves images.</p>

<h3>Creating an Node Server</h3>

<p>We&rsquo;ll use Express to serve the images.
We could work with any number of HTTP frameworks in Node, but Express is pretty simple to understand, so that&rsquo;s what we&rsquo;ll use.</p>

<p>First, create a package.json file so we can save our npm dependencies.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>npm init
</span><span class='line'><span class="c"># Follow the prompts</span>
</span><span class='line'><span class="c"># If in doubt, keep the defaults</span>
</span><span class='line'><span class="c"># For &quot;entry point&quot;, enter &quot;server.js&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next install some dependencies.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>npm install --save express azure-storage debug
</span></code></pre></td></tr></table></div></figure>


<p>The &ldquo;express&rdquo; and &ldquo;azure-storage&rdquo; packages should be pretty self-explanatory.
The &ldquo;debug&rdquo; prints debug output, and can be a selectively turned on and off.
We&rsquo;ll talk about how to use &ldquo;debug&rdquo; in a bit.</p>

<p>When we initialized the package.json, we set server.js as the entry point.
Let&rsquo;s create that.
(Skip ahead if you&rsquo;re familiar with Express)</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">debug</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;debug&#39;</span><span class="p">)(</span><span class="s1">&#39;placebacon:server&#39;</span><span class="p">),</span>
</span><span class='line'>    <span class="nx">storage</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;azure-storage&#39;</span><span class="p">),</span>
</span><span class='line'>    <span class="nx">http</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;http&#39;</span><span class="p">),</span>
</span><span class='line'>    <span class="nx">util</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;util&#39;</span><span class="p">),</span>
</span><span class='line'>    <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;express&#39;</span><span class="p">),</span>
</span><span class='line'>    <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'><span class="nx">app</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;port&#39;</span><span class="p">,</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PORT</span> <span class="o">||</span> <span class="mi">3000</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// TODO: add server routes</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">server</span> <span class="o">=</span> <span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;port&#39;</span><span class="p">),</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;Placebacon server listening on port %d&#39;</span><span class="p">,</span> <span class="nx">server</span><span class="p">.</span><span class="nx">address</span><span class="p">().</span><span class="nx">port</span><span class="p">);</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>We&rsquo;re requiring the &ldquo;debug&rdquo; package, then calling the function it exports with &lsquo;placebacon:server&rsquo;.
This tells &ldquo;debug&rdquo; to only print log output if the DEBUG environment variable matches &lsquo;placebacon:server&rsquo;.
For example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>node server.js
</span><span class='line'><span class="c"># [no output]</span>
</span><span class='line'>
</span><span class='line'><span class="nv">DEBUG</span><span class="o">=</span>placebacon:server node server.js
</span><span class='line'><span class="c"># =&gt; Placebacon server listening on port 3000</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="nv">DEBUG</span><span class="o">=</span>placebacon:* node server.js
</span><span class='line'><span class="c"># =&gt; Placebacon server listening on port 3000</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you can see from the above examples, &ldquo;debug&rdquo; makes it easy to turn debugging statements on and off without modifying your code.</p>

<h3>Defining the Route</h3>

<p>Next let&rsquo;s add a route.
In the javascript snippet above, replace the &ldquo;TODO&rdquo; line with the following code.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">// Matches /100/200 -&gt; 100x200 image</span>
</span><span class='line'><span class="c1">// Matches /100     -&gt; 100x100 image</span>
</span><span class='line'><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/:width/:height?&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">width</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">width</span><span class="p">);</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">height</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">height</span> <span class="o">?</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">height</span><span class="p">)</span> <span class="o">:</span> <span class="nx">width</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// If width or height isn&#39;t a number, go to next route</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nb">isNaN</span><span class="p">(</span><span class="nx">width</span><span class="p">)</span> <span class="o">||</span> <span class="nb">isNaN</span><span class="p">(</span><span class="nx">height</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">next</span><span class="p">();</span>
</span><span class='line'>        <span class="k">return</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">selectedImage</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// TODO: choose a random image</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">urlTemplate</span> <span class="o">=</span> <span class="s1">&#39;http://placebacon.net/%d/%d?image=%d&#39;</span><span class="p">;</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">imageUrl</span> <span class="o">=</span> <span class="nx">util</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="nx">urlTemplate</span><span class="p">,</span> <span class="nx">width</span><span class="p">,</span> <span class="nx">height</span><span class="p">,</span> <span class="nx">selectedImage</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;Fetching from %s&#39;</span><span class="p">,</span> <span class="nx">imageUrl</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">http</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">imageUrl</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">imageResponse</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="mi">200</span> <span class="o">!==</span> <span class="nx">imageResponse</span><span class="p">.</span><span class="nx">statusCode</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;Unexpected response: %d - %s&#39;</span><span class="p">,</span>
</span><span class='line'>                  <span class="nx">imageResponse</span><span class="p">.</span><span class="nx">statusCode</span><span class="p">,</span> <span class="nx">imageResponse</span><span class="p">.</span><span class="nx">statusMessage</span><span class="p">);</span>
</span><span class='line'>            <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="mi">502</span><span class="p">,</span> <span class="nx">imageResponse</span><span class="p">.</span><span class="nx">statusMessage</span><span class="p">);</span>
</span><span class='line'>            <span class="k">return</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">imageResponse</span><span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">res</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}).</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Error fetching from %s: %j&#39;</span><span class="p">,</span> <span class="nx">imageUrl</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
</span><span class='line'>        <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="mi">502</span><span class="p">,</span> <span class="nx">util</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="s2">&quot;Error downloading %s: %s&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="nx">imageUrl</span><span class="p">,</span>
</span><span class='line'>            <span class="nx">e</span><span class="p">.</span><span class="nx">message</span><span class="p">));</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>At this point we have a fairly functional non-caching proxy.
Let&rsquo;s briefly go over the code.</p>

<p>First, the route is defined as <code>/:width/:height?</code>.
This tells Express that we want to match routes with one or two parts (the question mark makes the second part optional).
Those two parts will be mapped to <code>req.params.width</code> and <code>req.params.height</code>.
If the second part is left off, <code>req.params.height</code> will be undefined.</p>

<p>Inside our route handler, we first parse the width and height as integers.
If the height is missing, it defaults to the value of &ldquo;width&rdquo;.
This allows users to use /100 as a shortcut for /100/100.</p>

<p>Next we check that width and height are actually integers.
If they aren&rsquo;t, we call &ldquo;next()&rdquo;, to pass control onto the next route handler.
In this case, there isn&rsquo;t another handler, so Express will send a 404.</p>

<p>Next we select an image.
In this sample, it&rsquo;s hardcoded to zero, but normally we&rsquo;ll want to select a random image based on width and height.
We&rsquo;ll add that later.</p>

<p>Based on the image selection and resolution, we construct a URL to our backend.
In the sample it points at placebacon.com to make it easy to run the sample, but normally you&rsquo;d point this at whatever service you&rsquo;re using to resize your images.
You&rsquo;ll also probably want to put the &ldquo;urlTemplate&rdquo; value in a config, but for the sake of code sample simplicity, it&rsquo;s hardcoded</p>

<p>Finally, we make an http request to the image url and pipe the response to our client.
The rest of the code is just error handling.</p>

<h3>Using Blob Storage</h3>

<p>In the code samples above, we don&rsquo;t actually use blob storage.
Since blob storage is what this series is all about, let&rsquo;s integrate it as a caching layer.</p>

<p>Resizing and cropping images can be an expensive operation.
On placebacon, it can take a several seconds.
Obviously that&rsquo;s not acceptible for every request, so generated images need to be cached to speed up responses.</p>

<p>First, make sure you&rsquo;ve set up your site to connect to to blob storage.
The &ldquo;<a href="http://willi.am/blog/2014/07/01/azure-blob-storage-and-node-first-steps/">First Steps</a>&rdquo; post in this series has instructions on how to do that.</p>

<p>Next, let&rsquo;s make sure the blob container exists.</p>

<p>At the top of &ldquo;server.js&rdquo;, right below the requires, add the container creation boilerplate we saw in the previous posts.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">blobService</span> <span class="o">=</span> <span class="nx">storage</span><span class="p">.</span><span class="nx">createBlobService</span><span class="p">();</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">containerName</span> <span class="o">=</span> <span class="s1">&#39;placeholder-images&#39;</span><span class="p">;</span>
</span><span class='line'><span class="nx">blobService</span><span class="p">.</span><span class="nx">createContainerIfNotExists</span><span class="p">(</span><span class="nx">containerName</span><span class="p">,</span>
</span><span class='line'>    <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t create container %s&quot;</span><span class="p">,</span> <span class="nx">containerName</span><span class="p">);</span>
</span><span class='line'>            <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Container %s created&#39;</span><span class="p">,</span> <span class="nx">containerName</span><span class="p">);</span>
</span><span class='line'>            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Container %s already exists&#39;</span><span class="p">,</span> <span class="nx">containerName</span><span class="p">);</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now in the route handler, we can interact with the blob storage container.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">// Matches /100/200 -&gt; 100x200 image</span>
</span><span class='line'><span class="c1">// Matches /100     -&gt; 100x100 image</span>
</span><span class='line'><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/:width/:height?&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">width</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">width</span><span class="p">);</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">height</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">height</span> <span class="o">?</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">height</span><span class="p">)</span> <span class="o">:</span> <span class="nx">width</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// If width or height isn&#39;t a number, go to next route</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nb">isNaN</span><span class="p">(</span><span class="nx">width</span><span class="p">)</span> <span class="o">||</span> <span class="nb">isNaN</span><span class="p">(</span><span class="nx">height</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">next</span><span class="p">();</span>
</span><span class='line'>        <span class="k">return</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">selectedImage</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// TODO: choose a random image</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">blobName</span> <span class="o">=</span> <span class="nx">util</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="s2">&quot;%d-%d-%s&quot;</span><span class="p">,</span> <span class="nx">width</span><span class="p">,</span> <span class="nx">height</span><span class="p">,</span> <span class="nx">selectedImage</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">blobService</span><span class="p">.</span><span class="nx">getBlobProperties</span><span class="p">(</span>
</span><span class='line'>        <span class="nx">containerName</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">blobName</span><span class="p">,</span>
</span><span class='line'>        <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">properties</span><span class="p">,</span> <span class="nx">status</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="nx">status</span><span class="p">.</span><span class="nx">isSuccessful</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="nx">res</span><span class="p">.</span><span class="nx">header</span><span class="p">(</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="s1">&#39;image/jpeg&#39;</span><span class="p">);</span>
</span><span class='line'>                <span class="nx">blobService</span><span class="p">.</span><span class="nx">createReadStream</span><span class="p">(</span><span class="nx">containerName</span><span class="p">,</span> <span class="nx">blobName</span><span class="p">).</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">res</span><span class="p">);</span>
</span><span class='line'>            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                <span class="c1">// Blob doesn&#39;t exist</span>
</span><span class='line'>                <span class="c1">// Fetch it from the service</span>
</span><span class='line'>                <span class="kd">var</span> <span class="nx">urlTemplate</span> <span class="o">=</span> <span class="s1">&#39;http://placebacon.net/%d/%d?image=%d&#39;</span><span class="p">;</span>
</span><span class='line'>                <span class="kd">var</span> <span class="nx">imageUrl</span> <span class="o">=</span> <span class="nx">util</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span>
</span><span class='line'>                    <span class="nx">urlTemplate</span><span class="p">,</span>
</span><span class='line'>                    <span class="nx">width</span><span class="p">,</span>
</span><span class='line'>                    <span class="nx">height</span><span class="p">,</span>
</span><span class='line'>                    <span class="nx">selectedImage</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>                <span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;Fetching from %s&#39;</span><span class="p">,</span> <span class="nx">imageUrl</span><span class="p">);</span>
</span><span class='line'>                <span class="nx">http</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">imageUrl</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">imageResponse</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                    <span class="k">if</span> <span class="p">(</span><span class="mi">200</span> <span class="o">!==</span> <span class="nx">imageResponse</span><span class="p">.</span><span class="nx">statusCode</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                        <span class="nx">debug</span><span class="p">(</span>
</span><span class='line'>                            <span class="s1">&#39;Unexpected response: %d - %s&#39;</span><span class="p">,</span>
</span><span class='line'>                            <span class="nx">imageResponse</span><span class="p">.</span><span class="nx">statusCode</span><span class="p">,</span>
</span><span class='line'>                            <span class="nx">imageResponse</span><span class="p">.</span><span class="nx">statusMessage</span><span class="p">);</span>
</span><span class='line'>                        <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="mi">502</span><span class="p">,</span> <span class="nx">imageResponse</span><span class="p">.</span><span class="nx">statusMessage</span><span class="p">);</span>
</span><span class='line'>                        <span class="k">return</span><span class="p">;</span>
</span><span class='line'>                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>                        <span class="c1">// Create a write  stream</span>
</span><span class='line'>                        <span class="kd">var</span> <span class="nx">blob</span> <span class="o">=</span> <span class="nx">blobService</span><span class="p">.</span><span class="nx">createWriteStreamToBlockBlob</span><span class="p">(</span>
</span><span class='line'>                            <span class="nx">containerName</span><span class="p">,</span>
</span><span class='line'>                            <span class="nx">blobName</span><span class="p">,</span>
</span><span class='line'>                            <span class="p">{</span> <span class="nx">contentType</span><span class="o">:</span> <span class="s1">&#39;image/jpeg&#39;</span> <span class="p">},</span>
</span><span class='line'>                            <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">result</span><span class="p">,</span> <span class="nx">response</span><span class="p">){</span>
</span><span class='line'>                                <span class="k">if</span><span class="p">(</span><span class="nx">error</span><span class="p">){</span>
</span><span class='line'>                                    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t upload %s&quot;</span><span class="p">,</span> <span class="nx">blobName</span><span class="p">);</span>
</span><span class='line'>                                    <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
</span><span class='line'>                                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                                    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Blob %s uploaded&#39;</span><span class="p">,</span> <span class="nx">blobName</span><span class="p">);</span>
</span><span class='line'>                                <span class="p">}</span>
</span><span class='line'>                            <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>                        <span class="nx">imageResponse</span><span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">blob</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>                        <span class="nx">res</span><span class="p">.</span><span class="nx">header</span><span class="p">(</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="s1">&#39;image/jpeg&#39;</span><span class="p">);</span>
</span><span class='line'>                        <span class="nx">imageResponse</span><span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">res</span><span class="p">);</span>
</span><span class='line'>                    <span class="p">}</span>
</span><span class='line'>                <span class="p">}).</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                    <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Error fetching from %s: %j&#39;</span><span class="p">,</span> <span class="nx">imageUrl</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
</span><span class='line'>                    <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="mi">502</span><span class="p">,</span> <span class="nx">util</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="s2">&quot;Error downloading %s: %s&quot;</span><span class="p">,</span>
</span><span class='line'>                        <span class="nx">imageUrl</span><span class="p">,</span>
</span><span class='line'>                        <span class="nx">e</span><span class="p">.</span><span class="nx">message</span><span class="p">));</span>
</span><span class='line'>                <span class="p">});</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">});</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Final Polish</h3>

<p>One last improvement we can make is to image selection.
In the above example, we hardcoded to the &ldquo;0th&rdquo; image, but we really want to select a pseudo-random image.
The only problem is, we want a specific resolution to always result in the same image, so using Math.random() isn&rsquo;t sufficient.</p>

<p>Using crypto to hash the width/height is a pretty straightforward solution.
There are probably better ways of getting an evenly distributed selection of images, but this works pretty well.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">crypto</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;crypto&#39;</span><span class="p">);</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">imageCount</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">selectImage</span><span class="p">(</span><span class="nx">width</span><span class="p">,</span> <span class="nx">height</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">md5</span> <span class="o">=</span> <span class="nx">crypto</span><span class="p">.</span><span class="nx">createHash</span><span class="p">(</span><span class="s1">&#39;md5&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">md5</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">width</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="nx">height</span><span class="p">);</span>
</span><span class='line'>    <span class="c1">// Digest and take the first handful of characters</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">hash</span> <span class="o">=</span> <span class="nx">md5</span><span class="p">.</span><span class="nx">digest</span><span class="p">(</span><span class="s1">&#39;hex&#39;</span><span class="p">).</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">hash</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="o">%</span> <span class="nx">imageCount</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Sample Code</h3>

<p>If you want to try the code in this post, you can check out the <a href="https://github.com/itsananderson/azure-blob-storage-node-sample">GitHub project page</a>.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Azure Blob Storage and Node: Blob Metadata]]></title>
    <link href="http://willi.am/blog/2014/07/08/azure-blob-storage-and-node-blob-metadata/"/>
    <updated>2014-07-08T20:47:12-07:00</updated>
    <id>http://willi.am/blog/2014/07/08/azure-blob-storage-and-node-blob-metadata</id>
    <content type="html"><![CDATA[<p><strong>This is part of a series on working with Azure Blob Storage in Node.</strong></p>

<ol>
<li><a href="http://willi.am/blog/2014/06/30/azure-blob-storage-and-node/">Introduction</a></li>
<li><a href="http://willi.am/blog/2014/07/01/azure-blob-storage-and-node-first-steps/">First Steps</a></li>
<li><a href="http://willi.am/blog/2014/07/02/azure-blob-storage-and-node-creating-blobs/">Creating Blobs</a></li>
<li><a href="http://willi.am/blog/2014/07/03/azure-blob-storage-and-node-downloading-blobs/">Downloading Blobs</a></li>
<li><a href="http://willi.am/blog/2014/07/07/azure-blob-storage-and-node-listing-blobs/">Listing Blobs</a></li>
<li><strong>Blob Metadata</strong></li>
<li><a href="http://willi.am/blog/2014/07/09/azure-blob-storage-and-node-all-together/">All Together</a></li>
</ol>


<h2>Working With Azure Blob Metadata</h2>

<p>In the <a href="http://willi.am/blog/2014/07/07/azure-blob-storage-and-node-listing-blobs/">previous post</a>, we talked about how to list blobs and containers in your account.
Today we&rsquo;ll discuss how to work with blob properties and metadata.</p>

<h3>Account Connection Boilerplate</h3>

<p>To work with blob storage, you first need to create a client instance.
To avoid duplicating code over and over, we&rsquo;ll do that once here, and assume it in the other code samples.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">storage</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;azure-storage&#39;</span><span class="p">);</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">blobService</span> <span class="o">=</span> <span class="nx">storage</span><span class="p">.</span><span class="nx">createBlobService</span><span class="p">();</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">containerName</span> <span class="o">=</span> <span class="s1">&#39;your-container-name&#39;</span><span class="p">;</span>
</span><span class='line'><span class="nx">blobService</span><span class="p">.</span><span class="nx">createContainerIfNotExists</span><span class="p">(</span><span class="nx">containerName</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t create container %s&quot;</span><span class="p">,</span> <span class="nx">containerName</span><span class="p">);</span>
</span><span class='line'>        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Container %s created&#39;</span><span class="p">,</span> <span class="nx">containerName</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Container %s already exists&#39;</span><span class="p">,</span> <span class="nx">containerName</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Your code goes here</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now for the rest of the code samples, we&rsquo;ll assume that they&rsquo;re replacing the &ldquo;Your code goes here&rdquo; placeholder in the code above.</p>

<h3>Fetching Blob Properties</h3>

<p>You can fetch the properties for a blob with the <code>getBlobProperties</code> method.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">blobName</span> <span class="o">=</span> <span class="s1">&#39;my-awesome-blob&#39;</span><span class="p">;</span>
</span><span class='line'><span class="nx">blobService</span><span class="p">.</span><span class="nx">getBlobProperties</span><span class="p">(</span><span class="nx">containerName</span><span class="p">,</span> <span class="nx">blobName</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t fetch properties for blob %s&quot;</span><span class="p">,</span> <span class="nx">blobName</span><span class="p">);</span>
</span><span class='line'>        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">response</span><span class="p">.</span><span class="nx">isSuccessful</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&quot;Blob %s wasn&#39;t found container %s&quot;</span><span class="p">,</span> <span class="nx">blobName</span><span class="p">,</span> <span class="nx">containerName</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Successfully fetched properties for blob %s&quot;</span><span class="p">,</span> <span class="nx">blobName</span><span class="p">);</span>
</span><span class='line'>        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>The blob properties object includes the blob&rsquo;s metadata.
If you only need the metadata, you can request just that with the next snippet.</p>

<h3>Fetching Blob Metadata</h3>

<p>You can fetch the properties for a blob with the <code>getBlobProperties</code> method.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">blobName</span> <span class="o">=</span> <span class="s1">&#39;my-awesome-blob&#39;</span><span class="p">;</span>
</span><span class='line'><span class="nx">blobService</span><span class="p">.</span><span class="nx">getBlobMetadata</span><span class="p">(</span><span class="nx">containerName</span><span class="p">,</span> <span class="nx">blobName</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t fetch metadata for blob %s&quot;</span><span class="p">,</span> <span class="nx">blobName</span><span class="p">);</span>
</span><span class='line'>        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">response</span><span class="p">.</span><span class="nx">isSuccessful</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&quot;Blob %s wasn&#39;t found container %s&quot;</span><span class="p">,</span> <span class="nx">blobName</span><span class="p">,</span> <span class="nx">containerName</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Successfully fetched metadata for blob %s&quot;</span><span class="p">,</span> <span class="nx">blobName</span><span class="p">);</span>
</span><span class='line'>        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">metadata</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Updating Blob Properties and Metadata</h3>

<p>A blob&rsquo;s properties and metadata can be updated with the <code>setBlobProperties</code> and <code>setBlobMetadata</code> methods.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">// Error checking removed for simplicity</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">blobName</span> <span class="o">=</span> <span class="s1">&#39;my-awesome-blob&#39;</span><span class="p">;</span>
</span><span class='line'><span class="nx">blobService</span><span class="p">.</span><span class="nx">getBlobProperties</span><span class="p">(</span>
</span><span class='line'>    <span class="nx">containerName</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">blobName</span><span class="p">,</span>
</span><span class='line'>    <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">properties</span> <span class="o">=</span> <span class="nx">result</span><span class="p">;</span>
</span><span class='line'>        <span class="nx">properties</span><span class="p">.</span><span class="nx">contentType</span> <span class="o">=</span> <span class="s1">&#39;image/jpeg&#39;</span><span class="p">;</span>
</span><span class='line'>        <span class="nx">blobService</span><span class="p">.</span><span class="nx">setBlobProperties</span><span class="p">(</span>
</span><span class='line'>            <span class="nx">containerName</span><span class="p">,</span>
</span><span class='line'>            <span class="nx">blobName</span><span class="p">,</span>
</span><span class='line'>            <span class="nx">properties</span><span class="p">,</span>
</span><span class='line'>            <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Successfully updated properties for blob %s&#39;</span><span class="p">,</span> <span class="nx">blobName</span><span class="p">);</span>
</span><span class='line'>            <span class="p">});</span>
</span><span class='line'>    <span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">// Error checking removed for simplicity</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">blobName</span> <span class="o">=</span> <span class="s1">&#39;my-awesome-blob&#39;</span><span class="p">;</span>
</span><span class='line'><span class="nx">blobService</span><span class="p">.</span><span class="nx">getBlobMetadata</span><span class="p">(</span>
</span><span class='line'>    <span class="nx">containerName</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">blobName</span><span class="p">,</span>
</span><span class='line'>    <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">metadata</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">metadata</span><span class="p">;</span>
</span><span class='line'>        <span class="nx">metadata</span><span class="p">.</span><span class="nx">hitcount</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">metadata</span><span class="p">.</span><span class="nx">hitcount</span> <span class="o">||</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>        <span class="nx">blobService</span><span class="p">.</span><span class="nx">setBlobMetadata</span><span class="p">(</span>
</span><span class='line'>            <span class="nx">containerName</span><span class="p">,</span>
</span><span class='line'>            <span class="nx">blobName</span><span class="p">,</span>
</span><span class='line'>            <span class="nx">metadata</span><span class="p">,</span>
</span><span class='line'>            <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Successfully updated metadata for blob %s&#39;</span><span class="p">,</span> <span class="nx">blobName</span><span class="p">);</span>
</span><span class='line'>            <span class="p">});</span>
</span><span class='line'>    <span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Avoiding Race Conditions</h3>

<p>In the previous examples, there&rsquo;s a potential race condition.
If the blob is updated between the time you fetch the properties/metadata and the time when you update them, the changes will override each other.</p>

<p>You can avoid this problem by using &ldquo;leases&rdquo;.</p>

<p>The idea of a blob lease is that it lets you temporarily &ldquo;lock&rdquo; a blob for modifications.
Once a lease is acquired for a blob, any modifications must include that lease&rsquo;s Id.</p>

<p>By default, leases don&rsquo;t have a set duration.
This means they won&rsquo;t expire automatically, and will need to be manually released.</p>

<p>The other alternative is to set a specific lease duration.
This is a good failsafe.
If your script throws an error and never releases the lease, it will still eventually expire.</p>

<p>Valid lease durations are between 15 and 60 seconds.
If you need a longer lease, you can renew the lease before it expires.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">// Recursively attempts to acquire a lease</span>
</span><span class='line'><span class="kd">function</span> <span class="nx">acquireLease</span><span class="p">(</span><span class="nx">containerName</span><span class="p">,</span> <span class="nx">blobName</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">blobService</span><span class="p">.</span><span class="nx">acquireLease</span><span class="p">(</span>
</span><span class='line'>        <span class="nx">containerName</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">blobName</span><span class="p">,</span>
</span><span class='line'>        <span class="p">{</span> <span class="nx">leaseDuration</span><span class="o">:</span> <span class="mi">15</span> <span class="p">},</span>
</span><span class='line'>        <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">code</span> <span class="o">===</span> <span class="s1">&#39;LeaseAlreadyPresent&#39;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                    <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>                        <span class="nx">acquireLease</span><span class="p">(</span><span class="nx">containerName</span><span class="p">,</span> <span class="nx">blobName</span><span class="p">,</span> <span class="nx">cb</span><span class="p">);</span>
</span><span class='line'>                    <span class="p">},</span> <span class="mi">100</span><span class="p">);</span>
</span><span class='line'>                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                    <span class="nx">cb</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                <span class="nx">cb</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">result</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">});</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">blobName</span> <span class="o">=</span> <span class="s1">&#39;my-awesome-blob&#39;</span><span class="p">;</span>
</span><span class='line'><span class="nx">acquireLease</span><span class="p">(</span><span class="nx">containerName</span><span class="p">,</span> <span class="nx">blobName</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">leaseId</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t acquire lease on blob %s&quot;</span><span class="p">,</span> <span class="nx">blobName</span><span class="p">);</span>
</span><span class='line'>        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">blobService</span><span class="p">.</span><span class="nx">getBlobMetadata</span><span class="p">(</span>
</span><span class='line'>            <span class="nx">containerName</span><span class="p">,</span>
</span><span class='line'>            <span class="nx">blobName</span><span class="p">,</span>
</span><span class='line'>            <span class="p">{</span> <span class="nx">leaseId</span><span class="o">:</span> <span class="nx">leaseId</span> <span class="p">},</span>
</span><span class='line'>            <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">blob</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                    <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t get metadata for blob %s&quot;</span><span class="p">,</span> <span class="nx">blobName</span><span class="p">);</span>
</span><span class='line'>                    <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
</span><span class='line'>                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                    <span class="kd">var</span> <span class="nx">metadata</span> <span class="o">=</span> <span class="nx">blob</span><span class="p">.</span><span class="nx">metadata</span><span class="p">;</span>
</span><span class='line'>                    <span class="nx">metadata</span><span class="p">.</span><span class="nx">hitcount</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">metadata</span><span class="p">.</span><span class="nx">hitcount</span> <span class="o">||</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>                    <span class="nx">blobService</span><span class="p">.</span><span class="nx">setBlobMetadata</span><span class="p">(</span>
</span><span class='line'>                        <span class="nx">containerName</span><span class="p">,</span>
</span><span class='line'>                        <span class="nx">blobName</span><span class="p">,</span>
</span><span class='line'>                        <span class="nx">metadata</span><span class="p">,</span>
</span><span class='line'>                        <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">blob</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Blob %s metadata updated&quot;</span><span class="p">,</span> <span class="nx">blobName</span><span class="p">);</span>
</span><span class='line'>                            <span class="nx">blobService</span><span class="p">.</span><span class="nx">releaseLease</span><span class="p">(</span>
</span><span class='line'>                                <span class="nx">containerName</span><span class="p">,</span>
</span><span class='line'>                                <span class="nx">blobName</span><span class="p">,</span>
</span><span class='line'>                                <span class="nx">leaseId</span><span class="p">,</span>
</span><span class='line'>                                <span class="kd">function</span><span class="p">()</span> <span class="p">{});</span>
</span><span class='line'>                        <span class="p">});</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">});</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Conclusion</h3>

<p>In this post we covered interacting with blob properties and metadata.
In the final post in this series, we&rsquo;ll talk about putting everything together to create an blob-backed web service.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Azure Blob Storage and Node: Listing Blobs]]></title>
    <link href="http://willi.am/blog/2014/07/07/azure-blob-storage-and-node-listing-blobs/"/>
    <updated>2014-07-07T17:33:03-07:00</updated>
    <id>http://willi.am/blog/2014/07/07/azure-blob-storage-and-node-listing-blobs</id>
    <content type="html"><![CDATA[<p><strong>This is part of a series on working with Azure Blob Storage in Node.</strong></p>

<ol>
<li><a href="http://willi.am/blog/2014/06/30/azure-blob-storage-and-node/">Introduction</a></li>
<li><a href="http://willi.am/blog/2014/07/01/azure-blob-storage-and-node-first-steps/">First Steps</a></li>
<li><a href="http://willi.am/blog/2014/07/02/azure-blob-storage-and-node-creating-blobs/">Creating Blobs</a></li>
<li><a href="http://willi.am/blog/2014/07/03/azure-blob-storage-and-node-downloading-blobs/">Downloading Blobs</a></li>
<li><strong>Listing Blobs</strong></li>
<li><a href="http://willi.am/blog/2014/07/08/azure-blob-storage-and-node-blob-metadata/">Blob Metadata</a></li>
<li><a href="http://willi.am/blog/2014/07/09/azure-blob-storage-and-node-all-together/">All Together</a></li>
</ol>


<h2>Listing Containers and Blobs in Storage</h2>

<p><a href="http://willi.am/blog/2014/07/03/azure-blob-storage-and-node-downloading-blobs/">Last time</a> we talked about downloading blobs from storage.
This time we&rsquo;ll cover listing your existing containers and blobs.</p>

<h3>Listing Containers in an Account</h3>

<p>Listing the containers in a storage account is easy with the <code>listContainerSegmented</code> method.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">storage</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;azure-storage&#39;</span><span class="p">);</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">blobService</span> <span class="o">=</span> <span class="nx">storage</span><span class="p">.</span><span class="nx">createBlobService</span><span class="p">();</span>
</span><span class='line'><span class="nx">blobService</span><span class="p">.</span><span class="nx">listContainersSegmented</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t list containers&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Successfully listed containers&#39;</span><span class="p">);</span>
</span><span class='line'>        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">entries</span><span class="p">);</span>
</span><span class='line'>        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">continuationToken</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you have enough containers, not all of them will be returned in one call.
If <code>result.continuationToken</code> is not null, there are more entries.
You can get the next segment of entries by calling listContainersSegmented again with <code>result.continuationToken</code> as the first result.</p>

<p>If you want to aggregate all containers, you can use the following code.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">storage</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;azure-storage&#39;</span><span class="p">);</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">blobService</span> <span class="o">=</span> <span class="nx">storage</span><span class="p">.</span><span class="nx">createBlobService</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">containers</span> <span class="o">=</span> <span class="p">[];</span>
</span><span class='line'><span class="kd">function</span> <span class="nx">aggregateContainers</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">cb</span><span class="p">(</span><span class="nx">er</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">containers</span> <span class="o">=</span> <span class="nx">containers</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">entries</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">continuationToken</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">blobService</span>
</span><span class='line'>                <span class="p">.</span><span class="nx">listContainersSegmented</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">continuationToken</span><span class="p">,</span> <span class="nx">aggregateContainers</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">cb</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">containers</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nx">blobService</span><span class="p">.</span><span class="nx">listContainersSegmented</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">aggregateContainers</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">containers</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t list containers&quot;</span><span class="p">);</span>
</span><span class='line'>            <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">containers</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Listing Blobs in a Container</h3>

<p>You can list blobs in a container with the <code>listBlobsSegmented</code> method.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">storage</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;azure-storage&#39;</span><span class="p">);</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">blobService</span> <span class="o">=</span> <span class="nx">storage</span><span class="p">.</span><span class="nx">createBlobService</span><span class="p">();</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">containerName</span> <span class="o">=</span> <span class="s1">&#39;your-container-name&#39;</span><span class="p">;</span>
</span><span class='line'><span class="nx">blobService</span><span class="p">.</span><span class="nx">listBlobsSegmented</span><span class="p">(</span><span class="nx">containerName</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t list blobs for container %s&quot;</span><span class="p">,</span> <span class="nx">containerName</span><span class="p">);</span>
</span><span class='line'>        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Successfully listed blobs for container %s&#39;</span><span class="p">,</span> <span class="nx">containerName</span><span class="p">);</span>
</span><span class='line'>        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">entries</span><span class="p">);</span>
</span><span class='line'>        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">continuationToken</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>As with containers, you can use the continuationToken to aggregate results.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">storage</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;azure-storage&#39;</span><span class="p">);</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">blobService</span> <span class="o">=</span> <span class="nx">storage</span><span class="p">.</span><span class="nx">createBlobService</span><span class="p">();</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">containerName</span> <span class="o">=</span> <span class="s1">&#39;your-container-name&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">blobs</span> <span class="o">=</span> <span class="p">[];</span>
</span><span class='line'><span class="kd">function</span> <span class="nx">aggregateBlobs</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">cb</span><span class="p">(</span><span class="nx">er</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">blobs</span> <span class="o">=</span> <span class="nx">blobs</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">entries</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">continuationToken</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">blobService</span><span class="p">.</span><span class="nx">listBlobsSegmented</span><span class="p">(</span>
</span><span class='line'>                <span class="nx">containerName</span><span class="p">,</span>
</span><span class='line'>                <span class="nx">result</span><span class="p">.</span><span class="nx">continuationToken</span><span class="p">,</span>
</span><span class='line'>                <span class="nx">aggregateBlobs</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">cb</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">blobs</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nx">blobService</span><span class="p">.</span><span class="nx">listBlobsSegmented</span><span class="p">(</span><span class="nx">containerName</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">aggregateBlobs</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">blobs</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t list blobs&quot;</span><span class="p">);</span>
</span><span class='line'>            <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">blobs</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Listing Blobs and Containers by Prefix</h3>

<p>If you want to &ldquo;query&rdquo; blobs and containers by a prefix, you can do so with the <code>listContainersSegmentedWithPrefix</code> and <code>listBlobsSegmentedWithPrefix</code> methods.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">storage</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;azure-storage&#39;</span><span class="p">);</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">blobService</span> <span class="o">=</span> <span class="nx">storage</span><span class="p">.</span><span class="nx">createBlobService</span><span class="p">();</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">prefix</span> <span class="o">=</span> <span class="s1">&#39;images-&#39;</span><span class="p">;</span>
</span><span class='line'><span class="nx">blobService</span><span class="p">.</span><span class="nx">listContainersSegmentedWithPrefix</span><span class="p">(</span>
</span><span class='line'>    <span class="nx">prefix</span><span class="p">,</span>
</span><span class='line'>    <span class="kc">null</span><span class="p">,</span>
</span><span class='line'>    <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t list containers&quot;</span><span class="p">);</span>
</span><span class='line'>            <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Found containers with prefix %s&quot;</span><span class="p">,</span> <span class="nx">prefix</span><span class="p">);</span>
</span><span class='line'>            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">entries</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">storage</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;azure-storage&#39;</span><span class="p">);</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">blobService</span> <span class="o">=</span> <span class="nx">storage</span><span class="p">.</span><span class="nx">createBlobService</span><span class="p">();</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">containerName</span> <span class="o">=</span> <span class="s1">&#39;your-container-name&#39;</span><span class="p">;</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">prefix</span> <span class="o">=</span> <span class="s1">&#39;image-&#39;</span><span class="p">;</span>
</span><span class='line'><span class="nx">blobService</span><span class="p">.</span><span class="nx">listBlobsSegmentedWithPrefix</span><span class="p">(</span>
</span><span class='line'>    <span class="nx">containerName</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">prefix</span><span class="p">,</span>
</span><span class='line'>    <span class="kc">null</span><span class="p">,</span>
</span><span class='line'>    <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t list blobs&quot;</span><span class="p">);</span>
</span><span class='line'>            <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Found blobs with prefix %s&quot;</span><span class="p">,</span> <span class="nx">prefix</span><span class="p">);</span>
</span><span class='line'>            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">entries</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Conclusion</h3>

<p>In this post we covered listing blobs and containers in your storage account.
In the next post, we&rsquo;ll cover <a href="http://willi.am/blog/2014/07/08/azure-blob-storage-and-node-blob-metadata/">blob metadata</a>.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Azure Blob Storage and Node: Downloading Blobs]]></title>
    <link href="http://willi.am/blog/2014/07/03/azure-blob-storage-and-node-downloading-blobs/"/>
    <updated>2014-07-03T16:23:46-07:00</updated>
    <id>http://willi.am/blog/2014/07/03/azure-blob-storage-and-node-downloading-blobs</id>
    <content type="html"><![CDATA[<p><strong>This is part of a series on working with Azure Blob Storage in Node.</strong></p>

<ol>
<li><a href="http://willi.am/blog/2014/06/30/azure-blob-storage-and-node/">Introduction</a></li>
<li><a href="http://willi.am/blog/2014/07/01/azure-blob-storage-and-node-first-steps/">First Steps</a></li>
<li><a href="http://willi.am/blog/2014/07/02/azure-blob-storage-and-node-creating-blobs/">Creating Blobs</a></li>
<li><strong>Downloading Blobs</strong></li>
<li><a href="http://willi.am/blog/2014/07/07/azure-blob-storage-and-node-listing-blobs/">Listing Blobs</a></li>
<li><a href="http://willi.am/blog/2014/07/08/azure-blob-storage-and-node-blob-metadata/">Blob Metadata</a></li>
<li><a href="http://willi.am/blog/2014/07/09/azure-blob-storage-and-node-all-together/">All Together</a></li>
</ol>


<h2>Downloading From Blob Storage</h2>

<p><a href="http://willi.am/blog/2014/07/02/azure-blob-storage-and-node-creating-blobs/">Last time</a> we talked about creating Azure blobs.
This time we&rsquo;ll turn things around and talk about downloading Azure blobs.</p>

<h3>Account Connection Boilerplate</h3>

<p>As stated in the previous post, to work with blob storage, you first need to create a client instance.
To avoid duplicating code over and over, we&rsquo;ll do that once here, and assume it in the other code samples.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">storage</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;azure-storage&#39;</span><span class="p">);</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">blobService</span> <span class="o">=</span> <span class="nx">storage</span><span class="p">.</span><span class="nx">createBlobService</span><span class="p">();</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">containerName</span> <span class="o">=</span> <span class="s1">&#39;your-container-name&#39;</span><span class="p">;</span>
</span><span class='line'><span class="nx">blobService</span><span class="p">.</span><span class="nx">createContainerIfNotExists</span><span class="p">(</span>
</span><span class='line'>    <span class="nx">containerName</span><span class="p">,</span>
</span><span class='line'>    <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t create container %s&quot;</span><span class="p">,</span> <span class="nx">containerName</span><span class="p">);</span>
</span><span class='line'>            <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Container %s created&#39;</span><span class="p">,</span> <span class="nx">containerName</span><span class="p">);</span>
</span><span class='line'>            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Container %s already exists&#39;</span><span class="p">,</span> <span class="nx">containerName</span><span class="p">);</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">// Your code goes here</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>Again, for the rest of the code samples, we&rsquo;ll assume that they&rsquo;re replacing the &ldquo;Your code goes here&rdquo; placeholder in the code above.</p>

<h3>Checking if a Blob Exists</h3>

<p>In some cases, you don&rsquo;t need a blob&rsquo;s contents, you just need to know if it exists.
You can do this with the <code>getBlobProperties</code> method.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">blobName</span> <span class="o">=</span> <span class="s1">&#39;my-nonexistent-blob&#39;</span>
</span><span class='line'><span class="nx">blobService</span><span class="p">.</span><span class="nx">getBlobProperties</span><span class="p">(</span>
</span><span class='line'>    <span class="nx">containerName</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">blobName</span><span class="p">,</span>
</span><span class='line'>    <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">properties</span><span class="p">,</span> <span class="nx">status</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nx">status</span><span class="p">.</span><span class="nx">isSuccessful</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="c1">// Blob exists</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="c1">// Blob doesn&#39;t exist</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Downloading a Blob As Text</h3>

<p>To download a blob as a text string, use the <code>getBlobToText</code> method.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">blobName</span> <span class="o">=</span> <span class="s1">&#39;my-awesome-text-blob&#39;</span><span class="p">;</span>
</span><span class='line'><span class="nx">blobService</span><span class="p">.</span><span class="nx">getBlobToText</span><span class="p">(</span>
</span><span class='line'>    <span class="nx">containerName</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">blobName</span><span class="p">,</span>
</span><span class='line'>    <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">blobContent</span><span class="p">,</span> <span class="nx">blob</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t download blob %s&quot;</span><span class="p">,</span> <span class="nx">blobName</span><span class="p">);</span>
</span><span class='line'>            <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Sucessfully downloaded blob %s&quot;</span><span class="p">,</span> <span class="nx">blobName</span><span class="p">);</span>
</span><span class='line'>            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">blobContent</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Downloading a Blob to a File</h3>

<p>To download a blob to a file, use the <code>getBlobToFile</code> method.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">);</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">fileName</span> <span class="o">=</span> <span class="s1">&#39;hello-world.txt&#39;</span><span class="p">;</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">blobName</span> <span class="o">=</span> <span class="s1">&#39;my-awesome-file-blob&#39;</span><span class="p">;</span>
</span><span class='line'><span class="nx">blobService</span><span class="p">.</span><span class="nx">getBlobToFile</span><span class="p">(</span>
</span><span class='line'>    <span class="nx">containerName</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">blobName</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">fileName</span><span class="p">,</span>
</span><span class='line'>    <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">blob</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t download blob %s&quot;</span><span class="p">,</span> <span class="nx">blobName</span><span class="p">);</span>
</span><span class='line'>            <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Sucessfully downloaded blob %s to %s&quot;</span><span class="p">,</span> <span class="nx">blobName</span><span class="p">,</span> <span class="nx">fileName</span><span class="p">);</span>
</span><span class='line'>            <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="nx">fileName</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">fileContents</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                    <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t read file %s&quot;</span><span class="p">,</span> <span class="nx">fileName</span><span class="p">);</span>
</span><span class='line'>                    <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
</span><span class='line'>                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">fileContents</span><span class="p">);</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">});</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Downloading a Blob to a Stream</h3>

<p>To download a blob to a stream, use the <code>getBlobToStream</code> method.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">// For simplicity, assume getSomeStream returns a writable stream</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">myStream</span> <span class="o">=</span> <span class="nx">getSomeStream</span><span class="p">();</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">blobName</span> <span class="o">=</span> <span class="s1">&#39;my-awesome-stream-blob&#39;</span><span class="p">;</span>
</span><span class='line'><span class="nx">blobService</span><span class="p">.</span><span class="nx">getBlobToStream</span><span class="p">(</span>
</span><span class='line'>    <span class="nx">containerName</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">blobName</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">myStream</span><span class="p">,</span>
</span><span class='line'>    <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">blob</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t download blob %s&quot;</span><span class="p">,</span> <span class="nx">blobName</span><span class="p">);</span>
</span><span class='line'>            <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Sucessfully downloaded blob %s&quot;</span><span class="p">,</span> <span class="nx">blobName</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>You can also integrate with a web server to enable downloads from blob storage.
This is powerfull when combined with the <code>getBlobProperties</code> method.</p>

<p>In the following example, we use the <code>createReadStream</code> method so we can easily pipe the stream to the server response object.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/download/:file&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">fileName</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">file</span><span class="p">;</span>
</span><span class='line'>    <span class="nx">blobService</span><span class="p">.</span><span class="nx">getBlobProperties</span><span class="p">(</span>
</span><span class='line'>        <span class="nx">containerName</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">fileName</span><span class="p">,</span>
</span><span class='line'>        <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">properties</span><span class="p">,</span> <span class="nx">status</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="mi">502</span><span class="p">,</span> <span class="s2">&quot;Error fetching file: %s&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
</span><span class='line'>            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">status</span><span class="p">.</span><span class="nx">isSuccessful</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="mi">404</span><span class="p">,</span> <span class="s2">&quot;The file %s does not exist&quot;</span><span class="p">,</span> <span class="nx">fileName</span><span class="p">);</span>
</span><span class='line'>            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                <span class="nx">res</span><span class="p">.</span><span class="nx">header</span><span class="p">(</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="nx">properties</span><span class="p">.</span><span class="nx">contentType</span><span class="p">);</span>
</span><span class='line'>                <span class="nx">blobService</span><span class="p">.</span><span class="nx">createReadStream</span><span class="p">(</span><span class="nx">containerName</span><span class="p">,</span> <span class="nx">fileName</span><span class="p">).</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">res</span><span class="p">);</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">});</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Conclusion</h3>

<p>In this post we covered how to check whether a blob exists, and how to download the blob.
In the next post, we&rsquo;ll cover <a href="http://willi.am/blog/2014/07/07/azure-blob-storage-and-node-listing-blobs/">how to list containers and blobs</a>.</p>
]]></content>
  </entry>
  
</feed>
